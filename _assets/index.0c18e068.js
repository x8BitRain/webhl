var e,t,s,i,r={},n=[],a=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function o(e,t){for(var s in t)e[s]=t[s];return e}function l(e){var t=e.parentNode;t&&t.removeChild(e)}function h(e,t,s){var i,r,n,a=arguments,o={};for(n in t)"key"==n?i=t[n]:"ref"==n?r=t[n]:o[n]=t[n];if(arguments.length>3)for(s=[s],n=3;n<arguments.length;n++)s.push(a[n]);if(null!=s&&(o.children=s),"function"==typeof e&&null!=e.defaultProps)for(n in e.defaultProps)void 0===o[n]&&(o[n]=e.defaultProps[n]);return c(e,o,i,r,null)}function c(t,s,i,r,n){var a={type:t,props:s,key:i,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:null==n?++e.__v:n};return null!=e.vnode&&e.vnode(a),a}function d(e){return e.children}function u(e,t){this.props=e,this.context=t}function p(e,t){if(null==t)return e.__?p(e.__,e.__.__k.indexOf(e)+1):null;for(var s;t<e.__k.length;t++)if(null!=(s=e.__k[t])&&null!=s.__e)return s.__e;return"function"==typeof e.type?p(e):null}function f(e){var t,s;if(null!=(e=e.__)&&null!=e.__c){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if(null!=(s=e.__k[t])&&null!=s.__e){e.__e=e.__c.base=s.__e;break}return f(e)}}function m(r){(!r.__d&&(r.__d=!0)&&t.push(r)&&!g.__r++||i!==e.debounceRendering)&&((i=e.debounceRendering)||s)(g)}function g(){for(var e;g.__r=t.length;)e=t.sort((function(e,t){return e.__v.__b-t.__v.__b})),t=[],e.some((function(e){var t,s,i,r,n,a;e.__d&&(n=(r=(t=e).__v).__e,(a=t.__P)&&(s=[],(i=o({},r)).__v=r.__v+1,k(a,r,i,t.__n,void 0!==a.ownerSVGElement,null!=r.__h?[n]:null,s,null==n?p(r):n,r.__h),v(s,r),r.__e!=n&&f(r)))}))}function E(e,t,s,i,a,o,l,h,u,f){var m,g,E,b,_,w,T,v=i&&i.__k||n,I=v.length;for(s.__k=[],m=0;m<t.length;m++)if(null!=(b=s.__k[m]=null==(b=t[m])||"boolean"==typeof b?null:"string"==typeof b||"number"==typeof b?c(null,b,null,null,b):Array.isArray(b)?c(d,{children:b},null,null,null):b.__b>0?c(b.type,b.props,b.key,null,b.__v):b)){if(b.__=s,b.__b=s.__b+1,null===(E=v[m])||E&&b.key==E.key&&b.type===E.type)v[m]=void 0;else for(g=0;g<I;g++){if((E=v[g])&&b.key==E.key&&b.type===E.type){v[g]=void 0;break}E=null}k(e,b,E=E||r,a,o,l,h,u,f),_=b.__e,(g=b.ref)&&E.ref!=g&&(T||(T=[]),E.ref&&T.push(E.ref,null,b),T.push(g,b.__c||_,b)),null!=_?(null==w&&(w=_),"function"==typeof b.type&&null!=b.__k&&b.__k===E.__k?b.__d=u=x(b,u,e):u=y(e,b,E,v,_,u),f||"option"!==s.type?"function"==typeof s.type&&(s.__d=u):e.value=""):u&&E.__e==u&&u.parentNode!=e&&(u=p(E))}for(s.__e=w,m=I;m--;)null!=v[m]&&("function"==typeof s.type&&null!=v[m].__e&&v[m].__e==s.__d&&(s.__d=p(i,m+1)),A(v[m],v[m]));if(T)for(m=0;m<T.length;m++)S(T[m],T[++m],T[++m])}function x(e,t,s){var i,r;for(i=0;i<e.__k.length;i++)(r=e.__k[i])&&(r.__=e,t="function"==typeof r.type?x(r,t,s):y(s,r,r,e.__k,r.__e,t));return t}function y(e,t,s,i,r,n){var a,o,l;if(void 0!==t.__d)a=t.__d,t.__d=void 0;else if(null==s||r!=n||null==r.parentNode)e:if(null==n||n.parentNode!==e)e.appendChild(r),a=null;else{for(o=n,l=0;(o=o.nextSibling)&&l<i.length;l+=2)if(o==r)break e;e.insertBefore(r,n),a=n}return void 0!==a?a:r.nextSibling}function b(e,t,s){"-"===t[0]?e.setProperty(t,s):e[t]=null==s?"":"number"!=typeof s||a.test(t)?s:s+"px"}function _(e,t,s,i,r){var n;e:if("style"===t)if("string"==typeof s)e.style.cssText=s;else{if("string"==typeof i&&(e.style.cssText=i=""),i)for(t in i)s&&t in s||b(e.style,t,"");if(s)for(t in s)i&&s[t]===i[t]||b(e.style,t,s[t])}else if("o"===t[0]&&"n"===t[1])n=t!==(t=t.replace(/Capture$/,"")),t=t.toLowerCase()in e?t.toLowerCase().slice(2):t.slice(2),e.l||(e.l={}),e.l[t+n]=s,s?i||e.addEventListener(t,n?T:w,n):e.removeEventListener(t,n?T:w,n);else if("dangerouslySetInnerHTML"!==t){if(r)t=t.replace(/xlink[H:h]/,"h").replace(/sName$/,"s");else if("href"!==t&&"list"!==t&&"form"!==t&&"download"!==t&&t in e)try{e[t]=null==s?"":s;break e}catch(e){}"function"==typeof s||(null!=s&&(!1!==s||"a"===t[0]&&"r"===t[1])?e.setAttribute(t,s):e.removeAttribute(t))}}function w(t){this.l[t.type+!1](e.event?e.event(t):t)}function T(t){this.l[t.type+!0](e.event?e.event(t):t)}function k(t,s,i,a,h,c,p,f,m){var g,x,y,b,w,T,k,v,S,A,M,R=s.type;if(void 0!==s.constructor)return null;null!=i.__h&&(m=i.__h,f=s.__e=i.__e,s.__h=null,c=[f]),(g=e.__b)&&g(s);try{e:if("function"==typeof R){if(v=s.props,S=(g=R.contextType)&&a[g.__c],A=g?S?S.props.value:g.__:a,i.__c?k=(x=s.__c=i.__c).__=x.__E:("prototype"in R&&R.prototype.render?s.__c=x=new R(v,A):(s.__c=x=new u(v,A),x.constructor=R,x.render=I),S&&S.sub(x),x.props=v,x.state||(x.state={}),x.context=A,x.__n=a,y=x.__d=!0,x.__h=[]),null==x.__s&&(x.__s=x.state),null!=R.getDerivedStateFromProps&&(x.__s==x.state&&(x.__s=o({},x.__s)),o(x.__s,R.getDerivedStateFromProps(v,x.__s))),b=x.props,w=x.state,y)null==R.getDerivedStateFromProps&&null!=x.componentWillMount&&x.componentWillMount(),null!=x.componentDidMount&&x.__h.push(x.componentDidMount);else{if(null==R.getDerivedStateFromProps&&v!==b&&null!=x.componentWillReceiveProps&&x.componentWillReceiveProps(v,A),!x.__e&&null!=x.shouldComponentUpdate&&!1===x.shouldComponentUpdate(v,x.__s,A)||s.__v===i.__v){x.props=v,x.state=x.__s,s.__v!==i.__v&&(x.__d=!1),x.__v=s,s.__e=i.__e,s.__k=i.__k,x.__h.length&&p.push(x);break e}null!=x.componentWillUpdate&&x.componentWillUpdate(v,x.__s,A),null!=x.componentDidUpdate&&x.__h.push((function(){x.componentDidUpdate(b,w,T)}))}x.context=A,x.props=v,x.state=x.__s,(g=e.__r)&&g(s),x.__d=!1,x.__v=s,x.__P=t,g=x.render(x.props,x.state,x.context),x.state=x.__s,null!=x.getChildContext&&(a=o(o({},a),x.getChildContext())),y||null==x.getSnapshotBeforeUpdate||(T=x.getSnapshotBeforeUpdate(b,w)),M=null!=g&&g.type===d&&null==g.key?g.props.children:g,E(t,Array.isArray(M)?M:[M],s,i,a,h,c,p,f,m),x.base=s.__e,s.__h=null,x.__h.length&&p.push(x),k&&(x.__E=x.__=null),x.__e=!1}else null==c&&s.__v===i.__v?(s.__k=i.__k,s.__e=i.__e):s.__e=function(e,t,s,i,a,o,h,c){var d,u,p,f,m=s.props,g=t.props,x=t.type,y=0;if("svg"===x&&(a=!0),null!=o)for(;y<o.length;y++)if((d=o[y])&&(d===e||(x?d.localName==x:3==d.nodeType))){e=d,o[y]=null;break}if(null==e){if(null===x)return document.createTextNode(g);e=a?document.createElementNS("http://www.w3.org/2000/svg",x):document.createElement(x,g.is&&g),o=null,c=!1}if(null===x)m===g||c&&e.data===g||(e.data=g);else{if(o=o&&n.slice.call(e.childNodes),u=(m=s.props||r).dangerouslySetInnerHTML,p=g.dangerouslySetInnerHTML,!c){if(null!=o)for(m={},f=0;f<e.attributes.length;f++)m[e.attributes[f].name]=e.attributes[f].value;(p||u)&&(p&&(u&&p.__html==u.__html||p.__html===e.innerHTML)||(e.innerHTML=p&&p.__html||""))}if(function(e,t,s,i,r){var n;for(n in s)"children"===n||"key"===n||n in t||_(e,n,null,s[n],i);for(n in t)r&&"function"!=typeof t[n]||"children"===n||"key"===n||"value"===n||"checked"===n||s[n]===t[n]||_(e,n,t[n],s[n],i)}(e,g,m,a,c),p)t.__k=[];else if(y=t.props.children,E(e,Array.isArray(y)?y:[y],t,s,i,a&&"foreignObject"!==x,o,h,e.firstChild,c),null!=o)for(y=o.length;y--;)null!=o[y]&&l(o[y]);c||("value"in g&&void 0!==(y=g.value)&&(y!==e.value||"progress"===x&&!y)&&_(e,"value",y,m.value,!1),"checked"in g&&void 0!==(y=g.checked)&&y!==e.checked&&_(e,"checked",y,m.checked,!1))}return e}(i.__e,s,i,a,h,c,p,m);(g=e.diffed)&&g(s)}catch(t){s.__v=null,(m||null!=c)&&(s.__e=f,s.__h=!!m,c[c.indexOf(f)]=null),e.__e(t,s,i)}}function v(t,s){e.__c&&e.__c(s,t),t.some((function(s){try{t=s.__h,s.__h=[],t.some((function(e){e.call(s)}))}catch(t){e.__e(t,s.__v)}}))}function S(t,s,i){try{"function"==typeof t?t(s):t.current=s}catch(t){e.__e(t,i)}}function A(t,s,i){var r,n,a;if(e.unmount&&e.unmount(t),(r=t.ref)&&(r.current&&r.current!==t.__e||S(r,null,s)),i||"function"==typeof t.type||(i=null!=(n=t.__e)),t.__e=t.__d=void 0,null!=(r=t.__c)){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(t){e.__e(t,s)}r.base=r.__P=null}if(r=t.__k)for(a=0;a<r.length;a++)r[a]&&A(r[a],s,i);null!=n&&l(n)}function I(e,t,s){return this.constructor(e,s)}function M(t,s,i){var a,o,l;e.__&&e.__(t,s),o=(a="function"==typeof i)?null:i&&i.__k||s.__k,l=[],k(s,t=(!a&&i||s).__k=h(d,null,[t]),o||r,r,void 0!==s.ownerSVGElement,!a&&i?[i]:o?null:s.firstChild?n.slice.call(s.childNodes):null,l,!a&&i?i:o?o.__e:s.firstChild,a),v(l,t)}function R(e,t={}){return new CustomEvent(e,t||{})}e={__e:function(e,t){for(var s,i,r;t=t.__;)if((s=t.__c)&&!s.__)try{if((i=s.constructor)&&null!=i.getDerivedStateFromError&&(s.setState(i.getDerivedStateFromError(e)),r=s.__d),null!=s.componentDidCatch&&(s.componentDidCatch(e),r=s.__d),r)return s.__E=s}catch(t){e=t}throw e},__v:0},u.prototype.setState=function(e,t){var s;s=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=o({},this.state),"function"==typeof e&&(e=e(o({},s),this.props)),e&&o(s,e),null!=e&&this.__v&&(t&&this.__h.push(t),m(this))},u.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),m(this))},u.prototype.render=d,t=[],s="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,g.__r=0;const L=window;let C;"undefined"!=typeof performance&&(performance.now()?C=()=>L.performance.now():L.performance.mozNow?C=()=>L.performance.mozNow():L.performance.msNow?C=()=>L.performance.msNow():L.performance.oNow?C=()=>L.performance.oNow():L.performance.webkitNow?C=()=>L.performance.webkitNow():Date.now&&(C=()=>Date.now()));const P=C||(()=>(new Date).getTime()),N=e=>{const t=Math.floor(e/60),s=Math.floor(e-60*t);return(t<10?"0"+t:t.toString())+":"+(s<10?"0"+s:s.toString())},D=window,U=new(D.AudioContext||D.webkitAudioContext);class F extends EventTarget{constructor(){super(),this.context=U;const e=parseFloat(localStorage.getItem("volume")||"0.3");localStorage.setItem("volume",e.toString()),this.channels=[],this.preMuteVolume=1,this.masterGain=this.context.createGain(),this.masterGain.gain.value=e,this.masterGain.connect(this.context.destination);for(let e=0;e<8;++e)this.channels.push({source:null,gain:this.context.createGain()}),this.channels[e].gain.connect(this.masterGain)}static getContext(){return U}play(e,t,s){this.stop(t);const i=this.channels[t].gain;i.gain.value=Math.max(0,Math.min(1,s));const r=this.context.createBufferSource();r.buffer=e.buffer,r.connect(i),r.start(0),this.channels[t].source=r}stop(e){const t=this.channels[e].source;t&&t.stop(0)}getVolume(){return this.masterGain.gain.value}setVolume(e){const t=this.masterGain.gain.value;t>0&&0===e&&(this.preMuteVolume=t),this.masterGain.gain.value=e,localStorage.setItem("volume",e.toString()),this.dispatchEvent(R("volumeChange",{detail:{item:e}}))}toggleMute(){0===this.getVolume()?this.setVolume(this.preMuteVolume):this.setVolume(0)}}class O{constructor(e){this.index=-1,this.name="",this.buffer=e}static create(e){return new Promise(((t,s)=>{F.getContext().decodeAudioData(e,(e=>{t(new O(e))}),(e=>{s(e)}))}))}}var B,V;(V=B||(B={}))[V.UByte=0]="UByte",V[V.Byte=1]="Byte",V[V.UShort=2]="UShort",V[V.Short=3]="Short",V[V.UInt=4]="UInt",V[V.Int=5]="Int",V[V.Float=6]="Float",V[V.Double=7]="Double",V[V.NString=8]="NString",V[V.String=9]="String";class G{constructor(e){this.data=new DataView(e),this.offset=0}length(){return this.data.byteLength}tell(){return this.offset}seek(e){this.offset=Math.max(0,e)}skip(e){this.seek(this.tell()+e)}b(){const e=this.data.getInt8(this.offset);return this.skip(1),e}ub(){const e=this.data.getUint8(this.offset);return this.skip(1),e}s(e=!0){const t=this.data.getInt16(this.offset,e);return this.skip(2),t}us(e=!0){const t=this.data.getUint16(this.offset,e);return this.skip(2),t}i(e=!0){const t=this.data.getInt32(this.tell(),e);return this.skip(4),t}ui(e=!0){const t=this.data.getUint32(this.tell(),e);return this.skip(4),t}f(e=!0){const t=this.data.getFloat32(this.tell(),e);return this.skip(4),t}lf(e=!0){const t=this.data.getFloat64(this.tell(),e);return this.skip(8),t}str(){let e=this.ub(),t="";for(;0!==e;)t+=String.fromCharCode(e),e=this.ub();return t}nstr(e){if(e<0)return"";let t="";for(;e>0;){e-=1;const s=this.ub();if(0===s)break;t+=String.fromCharCode(s)}return 0!==e&&this.skip(e),t}arr(e,t){t.bind(this);const s=[];for(;e-- >0;)s.push(t());return s}arrx(e,t,s=0){let i;switch(t){case 0:i=new Uint8Array(this.data.buffer,this.tell(),e),this.skip(e);break;case 1:i=new Int8Array(this.data.buffer,this.tell(),e),this.skip(e);break;case 2:i=new Uint16Array(this.data.buffer,this.tell(),e),this.skip(2*e);break;case 3:i=new Int16Array(this.data.buffer,this.tell(),e),this.skip(2*e);break;case 4:i=new Uint32Array(this.data.buffer,this.tell(),e),this.skip(4*e);break;case 5:i=new Int32Array(this.data.buffer,this.tell(),e),this.skip(4*e);break;case 6:i=new Float32Array(this.data.buffer,this.tell(),e),this.skip(4*e);break;case 7:i=new Float64Array(this.data.buffer,this.tell(),e),this.skip(8*e);break;case 8:for(i=[];e-- >0;)i.push(i.nstr(s));break;case 9:for(i=[];e-- >0;)i.push(i.str())}return i}}class X{constructor(e,t,s,i){this.name=e,this.width=t,this.height=s,this.data=i}static parse(e,t){let s=new G(e),i={idLength:s.ub(),colorMapType:s.ub(),imageType:s.ub(),colorMap:{firstEntryIndex:s.us(),length:s.us(),size:s.ub()},image:{xOrigin:s.us(),yOrigin:s.us(),width:s.us(),height:s.us(),depth:s.ub(),descriptor:s.ub()}};if(i.idLength&&s.arrx(i.idLength,B.UByte),i.colorMapType)throw new Error("Not implemented");let r,n=i.image.width,a=i.image.height,o=n*a;if(2===i.imageType){let e=o*i.image.depth/8;if(r=s.arrx(e,B.UByte),24===i.image.depth){let e=new Uint8Array(4*o);for(let t=0;t<a;++t)for(let s=0;s<n;++s){let i=(a-1-t)*n+s;e[4*i]=r[3*(t*n+s)+2],e[4*i+1]=r[3*(t*n+s)+1],e[4*i+2]=r[3*(t*n+s)],e[4*i+3]=255}r=e}else if(32===i.image.depth){let e=new Uint8Array(4*o);for(let t=0;t<a;++t)for(let s=0;s<n;++s){let i=(a-1-t)*n+s;e[4*i]=r[4*(t*n+s)+2],e[4*i+1]=r[4*(t*n+s)+1],e[4*i+2]=r[4*(t*n+s)],e[4*i+3]=255}r=e}}else if(10===i.imageType&&(r=new Uint8Array(4*o),24===i.image.depth))for(let e=0;e<a;++e)for(let t=0;t<n;){let i=s.ub();if(128&i){i=1+(127&i);let o=s.ub(),l=s.ub(),h=s.ub();for(;t<n&&i;){let s=(a-1-e)*n+t;r[4*s]=h,r[4*s+1]=l,r[4*s+2]=o,r[4*s+3]=255,++t,--i}}else for(i=1+(127&i);t<n&&i;){let o=(a-1-e)*n+t;r[4*o+2]=s.ub(),r[4*o+1]=s.ub(),r[4*o]=s.ub(),r[4*o+3]=255,++t,--i}}return new X(t,i.image.width,i.image.height,r)}}function H(e,t){const s=new Uint8Array(4*e.length),i=e.length;for(let r=0;r<i;++r)s[4*r]=t[3*e[r]],s[4*r+1]=t[3*e[r]+1],s[4*r+2]=t[3*e[r]+2],s[4*r+3]=255;return s}function W(e,t){const s=new Uint8Array(4*e.length),i=e.length;for(let r=0;r<i;++r)255===e[r]?s[4*r+3]=0:(s[4*r]=t[3*e[r]],s[4*r+1]=t[3*e[r]+1],s[4*r+2]=t[3*e[r]+2],s[4*r+3]=255);return s}function z(e,t){switch(e.seek(t.offset),t.type){case 64:return function(e){const t=e.nstr(16),s=e.ui(),i=e.ui();e.skip(16);const r=s*i,n=e.arrx(r,B.UByte);e.skip(r/64*21),e.skip(2);const a=e.arrx(768,B.UByte);return{type:"decal",name:t,width:s,height:i,data:"{"===t[0]?W(n,a):H(n,a)}}(e);case 66:return((e,t)=>({type:"cache",name:t.name}))(0,t);case 67:return function(e){const t=e.nstr(16),s=e.ui(),i=e.ui();e.skip(16);const r=s*i,n=e.arrx(r,B.UByte);e.skip(r/64*21),e.skip(2);const a=e.arrx(768,B.UByte);return{type:"texture",name:t,width:s,height:i,data:"{"===t[0]?W(n,a):H(n,a)}}(e);case 70:return function(e,t){const s=e.ui()&&256,i=e.ui(),r=e.ui(),n=e.ui(),a=[];for(let t=0;t<256;++t){const t=e.us(),i=e.us();a.push({x:t%s,y:Math.floor(t/s)/n*n,width:i,height:n})}const o=s*i,l=e.arrx(o,B.UByte);e.skip(2);const h=e.arrx(768,B.UByte);return{type:"font",name:t.name,width:s,height:i,rowCount:r,rowHeight:n,glyphs:a,data:W(l,h)}}(e,t);default:return((e,t)=>({type:"unknown",name:t.name,data:e.arrx(t.length,B.UByte)}))(e,t)}}class ${constructor(e){this.entries=e}static parse(e){const t=new G(e);if("WAD3"!==t.nstr(4))throw new Error("Invalid WAD file format");const s=t.ui(),i=t.ui();t.seek(i);const r=[];for(let e=0;e<s;++e){const e={offset:t.ui(),diskLength:t.ui(),length:t.ui(),type:t.b(),isCompressed:t.b(),name:""};t.skip(2),e.name=t.nstr(16),r.push(e)}const n=r.map((e=>z(t,e)));return new $(n)}}class Y{constructor(e){this.name=e.split("/").reverse()[0].split(".")[0],this.chunks=[],this.resources={sounds:[],skins:[],models:[],decals:[],custom:[],events:[]}}setResources(e){e.forEach((e=>{switch(e.type){case 0:e.used=!1,this.resources.sounds.push(e);break;case 1:this.resources.skins.push(e);break;case 2:this.resources.models.push(e);break;case 3:this.resources.decals.push(e);break;case 4:this.resources.custom.push(e);break;case 5:this.resources.events.push(e)}}))}addChunk(e){this.chunks.push(e)}}class j{constructor(e,t){this.state=e.clone(),this.startTime=t,this.timeLength=10,this.data=null,this.reader=null}setData(e){this.data=new Uint8Array(e.length);for(let t=0;t<e.length;++t)this.data[t]=e[t];this.reader=new G(this.data.buffer)}}class K{constructor(e=null){e?(this.cameraPos=JSON.parse(JSON.stringify(e.cameraPos)),this.cameraRot=JSON.parse(JSON.stringify(e.cameraRot)),this.entities=JSON.parse(JSON.stringify(e.entities))):(this.cameraPos=[0,0,0],this.cameraRot=[0,0,0],this.entities=[])}feedFrame(e){switch(e.type){case 0:case 1:this.cameraPos[0]=e.camera.position[0],this.cameraPos[1]=e.camera.position[1],this.cameraPos[2]=e.camera.position[2],this.cameraRot[0]=e.camera.orientation[0],this.cameraRot[1]=e.camera.orientation[1],this.cameraRot[2]=e.camera.orientation[2]}}clone(){return new K(this)}}function q(e){let t=e.readBits(1),s=e.readBits(1);if(!t&&!s)return 0;let i=e.readBits(1),r=0,n=0;t&&(r=e.readBits(12)),s&&(n=e.readBits(3));let a=r+n/32;return i&&(a=-a),a}var Z,Q;function J(e,t){let s={},i=e.readBits(3),r=[];for(let t=0;t<i;++t)r.push(e.readBits(8));let n=!1;for(let a=0;a<i;++a){for(let i=0;i<8;++i){let o=i+8*a;if(o===t.length){n=!0;break}if(r[a]&1<<i)if(t[o].flags&Z.DT_BYTE)if(t[o].flags&Z.DT_SIGNED){let i=e.readBits(1)?-1:1,r=e.readBits(t[o].bits-1),n=t[o].divisor;s[t[o].name]=i*r/n}else{let i=e.readBits(t[o].bits),r=t[o].divisor;s[t[o].name]=i/r}else if(t[o].flags&Z.DT_SHORT)if(t[o].flags&Z.DT_SIGNED){let i=e.readBits(1)?-1:1,r=e.readBits(t[o].bits-1),n=t[o].divisor;s[t[o].name]=i*r/n}else{let i=e.readBits(t[o].bits),r=t[o].divisor;s[t[o].name]=i/r}else if(t[o].flags&Z.DT_INTEGER)if(t[o].flags&Z.DT_SIGNED){let i=e.readBits(1)?-1:1,r=e.readBits(t[o].bits-1),n=t[o].divisor;s[t[o].name]=i*r/n}else{let i=e.readBits(t[o].bits),r=t[o].divisor;s[t[o].name]=i/r}else if(t[o].flags&Z.DT_FLOAT||t[o].flags&Z.DT_TIMEWINDOW_8||t[o].flags&Z.DT_TIMEWINDOW_BIG)if(t[o].flags&Z.DT_SIGNED){let i=e.readBits(1)?-1:1,r=e.readBits(t[o].bits-1),n=t[o].divisor;s[t[o].name]=i*r/n}else{let i=e.readBits(t[o].bits),r=t[o].divisor;s[t[o].name]=i/r}else if(t[o].flags&Z.DT_ANGLE){let i=e.readBits(t[o].bits),r=360/(1<<t[o].bits);s[t[o].name]=i*r}else t[o].flags&Z.DT_STRING&&(s[t[o].name]=e.readString())}if(n)break}return s}(Q=Z||(Z={}))[Q.DT_BYTE=1]="DT_BYTE",Q[Q.DT_SHORT=2]="DT_SHORT",Q[Q.DT_FLOAT=4]="DT_FLOAT",Q[Q.DT_INTEGER=8]="DT_INTEGER",Q[Q.DT_ANGLE=16]="DT_ANGLE",Q[Q.DT_TIMEWINDOW_8=32]="DT_TIMEWINDOW_8",Q[Q.DT_TIMEWINDOW_BIG=64]="DT_TIMEWINDOW_BIG",Q[Q.DT_STRING=128]="DT_STRING",Q[Q.DT_SIGNED=-2147483648]="DT_SIGNED";const ee={delta_description_t:[{name:"flags",bits:32,divisor:1,flags:Z.DT_INTEGER},{name:"name",bits:8,divisor:1,flags:Z.DT_STRING},{name:"offset",bits:16,divisor:1,flags:Z.DT_INTEGER},{name:"size",bits:8,divisor:1,flags:Z.DT_INTEGER},{name:"bits",bits:8,divisor:1,flags:Z.DT_INTEGER},{name:"divisor",bits:32,divisor:4e3,flags:Z.DT_FLOAT},{name:"preMultiplier",bits:32,divisor:4e3,flags:Z.DT_FLOAT}]},te=()=>({...ee}),se=class{constructor(e){this.view=new Uint8Array(e,0,e.byteLength)}getBits(e,t,s=!1){if(t>8*this.view.length-e)throw new Error("Bits out of bounds");let i=0;for(let s=0;s<t;){const r=t-s,n=7&e,a=this.view[e>>3],o=Math.min(r,8-n);i|=(a>>n&(1<<o)-1)<<s,e+=o,s+=o}return s?(32!==t&&i&1<<t-1&&(i|=-1^(1<<t)-1),i):i>>>0}getInt8(e){return this.getBits(e,8,!0)}getUint8(e){return this.getBits(e,8,!1)}getInt16(e){return this.getBits(e,16,!0)}getUint16(e){return this.getBits(e,16,!1)}getInt32(e){return this.getBits(e,32,!0)}getUint32(e){return this.getBits(e,32,!1)}getFloat32(e){return se.scratch.setUint32(0,this.getUint32(e)),se.scratch.getFloat32(0)}getFloat64(e){return se.scratch.setUint32(0,this.getUint32(e)),se.scratch.setUint32(4,this.getUint32(e+32)),se.scratch.getFloat64(0)}};let ie=se;ie.scratch=new DataView(new ArrayBuffer(8));class re{constructor(e){this.view=new ie(e),this.index=0}readBits(e,t=!1){const s=this.view.getBits(this.index,e,t);return this.index+=e,s}readInt8(){const e=this.view.getInt8(this.index);return this.index+=8,e}readUint8(){const e=this.view.getUint8(this.index);return this.index+=8,e}readInt16(){const e=this.view.getInt16(this.index);return this.index+=16,e}readUint16(){const e=this.view.getUint16(this.index);return this.index+=16,e}readInt32(){const e=this.view.getInt32(this.index);return this.index+=32,e}readUint32(){const e=this.view.getUint32(this.index);return this.index+=32,e}readFloat32(){const e=this.view.getFloat32(this.index);return this.index+=32,e}readFloat64(){const e=this.view.getFloat64(this.index);return this.index+=64,e}readString(e=0,t=!1){let s=0;const i=[];let r=!0;for(;!e||e&&s<e;){const t=this.readUint8();if(0===t&&(r=!1,!e))break;r&&i.push(t),s++}const n=String.fromCharCode.apply(null,i);if(!t)return n;try{return decodeURIComponent(n)}catch(e){return n}}}const ne=class{static bad(){throw new Error("Invalid message type")}static nop(){return null}static disconnect(e){return{reason:e.str()}}static event(e,t){let s=new re(e.data.buffer);s.index=8*e.tell();let i=[],r=s.readBits(5);for(let e=0;e<r;++e){let e={index:s.readBits(10)};if(s.readBits(1)){e.packetIndex=s.readBits(11),s.readBits(1)&&(e.delta=J(s,t.event_t))}s.readBits(1)&&(e.fireTime=s.readBits(16)),i.push(e)}return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{events:i}}static version(e){return{version:e.ui()}}static setView(e){return{entityIndex:e.s()}}static sound(e){let t=new re(e.data.buffer);t.index=8*e.tell();let s=t.readBits(9),i=1;0!=(1&s)&&(i=t.readBits(8)/255);let r=1;0!=(2&s)&&(r=t.readBits(8)/64);let n,a=t.readBits(3),o=t.readBits(11);n=0!=(4&s)?t.readBits(16):t.readBits(8);let l,h,c,d=t.readBits(1),u=t.readBits(1),p=t.readBits(1);d&&(l=q(t)),u&&(h=q(t)),p&&(c=q(t));let f=1;return 0!=(8&s)&&(f=t.readBits(8)),t.index%8>0?e.seek(Math.floor(t.index/8)+1):e.seek(t.index/8),{flags:s,volume:i,attenuation:r,channel:a,entityIndex:o,soundIndex:n,xPosition:l,yPosition:h,zPosition:c,pitch:f}}static time(e){return{time:e.f()}}static print(e){return{message:e.str()}}static stuffText(e){return{commands:e.str().split(";").map((e=>{let t=e.split(/\s*("[^"]+"|[^\s"]+)/).map((e=>e.replace(/^"(.*)"$/,"$1").trim())).filter((e=>e));return{func:t[0],params:t.slice(1)}}))}}static setAngle(e){return{pitch:e.s(),yaw:e.s(),roll:e.s()}}static serverInfo(e){let t={protocol:e.i(),spawnCount:e.i(),mapCrc:e.i(),clientDllHash:e.arrx(16,B.UByte),maxPlayers:e.ub(),playerIndex:e.ub(),isDeathmatch:e.ub(),gameDir:e.str(),hostName:e.str(),mapFileName:e.str(),mapCycle:e.str()};return e.skip(1),t}static lightStyle(e){return{index:e.ub(),lightInfo:e.str()}}static updateUserInfo(e){return{clientIndex:e.ub(),clientUserId:e.ui(),clientUserInfo:e.str(),clientCdKeyHash:e.arrx(16,B.UByte)}}static deltaDescription(e,t){let s={name:e.str(),fields:[]},i=new re(e.data.buffer),r=e.us();i.index=8*e.tell();for(let e=0;e<r;++e)s.fields.push(J(i,t.delta_description_t));return t[s.name]=s.fields,i.index%8>0?e.seek(Math.floor(i.index/8)+1):e.seek(i.index/8),s}static clientData(e,t){let s=new re(e.data.buffer);s.index=8*e.tell(),s.readBits(1)&&(s.index+=8);let i=J(s,t.clientdata_t),r=t.weapon_data_t;for(;s.readBits(1);)s.index+=6,J(s,r);return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{clientData:i}}static stopSound(e){return{entityIndex:e.s()}}static pings(e){let t=new re(e.data.buffer);t.index=8*e.tell();let s=[];for(;t.readBits(1);)s.push({slot:t.readBits(8),ping:t.readBits(8),loss:t.readBits(8)});return t.index%8>0?e.seek(Math.floor(t.index/8)+1):e.seek(t.index/8),s}static particle(e){return{position:[e.s()/8,e.s()/8,e.s()/8],direction:[e.b(),e.b(),e.b()],count:e.ub(),color:e.ub()}}static damage(){return null}static spawnStatic(e){let t={modelIndex:e.s(),sequence:e.b(),frame:e.b(),colorMap:e.s(),skin:e.b(),position:[],rotation:[]};return t.position[0]=e.s()/8,t.rotation[0]=1.40625*e.b(),t.position[1]=e.s()/8,t.rotation[1]=1.40625*e.b(),t.position[2]=e.s()/8,t.rotation[2]=1.40625*e.b(),t.renderMode=e.b(),t.renderMode&&(t.renderAmt=e.b(),t.renderColor=[e.ub(),e.ub(),e.ub()],t.renderFx=e.b()),t}static eventReliable(e,t){let s=new re(e.data.buffer);s.index=8*e.tell();let i,r=s.readBits(10),n=J(s,t.event_t),a=s.readBits(1);return a&&(i=s.readBits(16)),s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{eventIndex:r,eventData:n,delayBit:a,delay:i}}static spawnBaseLine(e,t){let s=new re(e.data.buffer);s.index=8*e.tell();let i=[];for(;;){let e,r=s.readBits(11);if(2047===r)break;e=1&s.readBits(2)?r>0&&r<=32?"entity_state_player_t":"entity_state_t":"custom_entity_state_t",i[r]=J(s,t[e])}if(31!==s.readBits(5))throw new Error("Bad spawnbaseline");let r=s.readBits(6),n=[];for(let e=0;e<r;++e)n.push(J(s,t.entity_state_t));return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{entities:i,extraData:n}}static tempEntity(e){let t={};switch(e.ub()){case 0:e.skip(24);break;case 1:e.skip(20);break;case 2:e.skip(6);break;case 3:e.skip(11);break;case 4:e.skip(6);break;case 5:e.skip(10);break;case 6:e.skip(12);break;case 7:e.skip(17);break;case 8:e.skip(16);break;case 9:case 10:case 11:e.skip(6);break;case 12:e.skip(8);break;case 13:e.skip(8),e.s()&&e.skip(2);break;case 14:e.skip(9);break;case 15:e.skip(19);break;case 17:e.skip(10);break;case 18:e.skip(16);break;case 19:case 20:case 21:e.skip(24);break;case 22:e.skip(10);break;case 23:e.skip(11);break;case 24:e.skip(16);break;case 25:e.skip(19);break;case 27:e.skip(12);break;case 28:e.skip(16);break;case 29:t.channel=e.b(),t.x=e.s(),t.y=e.s(),t.effect=e.b(),t.textColor=[e.ub(),e.ub(),e.ub(),e.ub()],t.effectColor=[e.ub(),e.ub(),e.ub(),e.ub()],t.fadeInTime=e.s(),t.fadeOutTime=e.s(),t.holdTime=e.s(),t.effect&&(t.effectTime=e.s()),t.message=e.str();break;case 30:case 31:e.skip(17);break;case 99:e.skip(2);break;case 100:e.skip(10);break;case 101:e.skip(14);break;case 102:e.skip(12);break;case 103:e.skip(14);break;case 104:e.skip(9);break;case 105:e.skip(5);break;case 106:e.skip(17);break;case 107:e.skip(13);break;case 108:e.skip(24);break;case 109:e.skip(9);break;case 110:e.skip(17);break;case 111:e.skip(7);break;case 112:e.skip(10);break;case 113:case 114:e.skip(19);break;case 115:e.skip(12);break;case 116:case 117:e.skip(7);break;case 118:e.skip(9);break;case 119:e.skip(16);break;case 120:e.skip(18);break;case 121:e.skip(5);break;case 122:e.skip(10);break;case 123:e.skip(9);break;case 124:e.skip(7);break;case 125:e.skip(1);break;case 126:e.skip(18);break;case 127:e.skip(15);break;default:throw new Error("Unknown temp entity type")}return t}static setPause(e){return{isPaused:e.b()}}static signOnNum(e){return{sign:e.b()}}static centerPrint(e){return{message:e.str()}}static killedMonster(){return null}static foundSecret(){return null}static spawnStaticSound(e){return{position:[e.s()/8,e.s()/8,e.s()/8],soundIndex:e.us(),volume:e.ub()/255,attenuation:e.ub()/64,entityIndex:e.us(),pitch:e.ub(),flags:e.ub()}}static intermission(){return null}static finale(e){return{text:e.str()}}static cdTrack(e){return{track:e.b(),loopTrack:e.b()}}static restore(e){let t=e.str(),s=e.ub(),i=[];for(let t=0;t<s;++t)i.push(e.str());return{saveName:t,maps:i}}static cutscene(e){return{text:e.str()}}static weaponAnim(e){return{sequenceNumber:e.b(),weaponModelBodyGroup:e.b()}}static decalName(e){return{positionIndex:e.ub(),decalName:e.str()}}static roomType(e){return{type:e.us()}}static addAngle(e){return{angleToAdd:e.s()/(360/65536)}}static newUserMsg(e){return{index:e.ub(),size:e.b(),name:e.nstr(16)}}static packetEntities(e,t){let s=new re(e.data.buffer);s.index=8*e.tell();let i=[];s.readBits(16);let r=0;for(;;){if(0===s.readBits(16))break;if(s.index-=16,s.readBits(1))r++;else{s.readBits(1)?r=s.readBits(11):r+=s.readBits(6)}let e=s.readBits(1);s.readBits(1)&&(s.index+=6);let n="entity_state_t";r>0&&r<=32?n="entity_state_player_t":e&&(n="custom_entity_state_t"),i.push(J(s,t[n]))}return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{entityStates:i}}static deltaPacketEntities(e,t){let s=new re(e.data.buffer);s.index=8*e.tell(),s.readBits(16),s.index+=8;let i=[],r=0;for(;;){if(0===s.readBits(16))break;s.index-=16;let e=s.readBits(1);if(s.readBits(1)?r=s.readBits(11):r+=s.readBits(6),e)continue;let n=s.readBits(1),a="entity_state_t";r>0&&r<32?a="entity_state_player_t":n&&(a="custom_entity_state_t"),i[r]=J(s,t[a])}return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{entityStates:i}}static choke(){return null}static resourceList(e){let t=new re(e.data.buffer);t.index=8*e.tell();let s=[],i=t.readBits(12);for(let e=0;e<i;++e){let e={};e.type=t.readBits(4),e.name=t.readString(),e.index=t.readBits(12),e.size=t.readBits(24),4&t.readBits(3)&&(t.index+=128),t.readBits(1)&&(t.index+=256),s.push(e)}if(t.readBits(1))for(;t.readBits(1);){let e=t.readBits(1)?5:10;t.index+=e}return t.index%8>0?e.seek(Math.floor(t.index/8)+1):e.seek(t.index/8),s}static newMoveVars(e){return{gravity:e.f(),stopSpeed:e.f(),maxSpeed:e.f(),spectatorMaxSpeed:e.f(),acceleration:e.f(),airAcceleration:e.f(),waterAcceleration:e.f(),friction:e.f(),edgeFriction:e.f(),waterFriction:e.f(),entityGravity:e.f(),bounce:e.f(),stepSize:e.f(),maxVelocity:e.f(),zMax:e.f(),waveHeight:e.f(),footsteps:e.b(),rollAngle:e.f(),rollSpeed:e.f(),skyColor:[e.f(),e.f(),e.f()],skyVec:[e.f(),e.f(),e.f()],skyName:e.str()}}static resourceRequest(e){let t={spawnCount:e.i()};return e.skip(4),t}static customization(e){let t,s=e.ub(),i=e.ub(),r=e.str(),n=e.us(),a=e.ui(),o=e.ub();return 4&o&&(t=[e.i(),e.i(),e.i(),e.i()]),{playerIndex:s,type:i,name:r,index:n,downloadSize:a,flags:o,md5hash:t}}static crosshairAngle(e){return{pitch:e.b(),yaw:e.b()}}static soundFade(e){return{initialPercent:e.ub(),holdTime:e.ub(),fadeOutTime:e.ub(),fadeInTime:e.ub()}}static fileTxferFailed(e){return{filename:e.str()}}static hltv(e){return{mode:e.ub()}}static director(e){let t=e.ub();return{flag:e.ub(),message:e.nstr(t-1)}}static voiceInit(e){return{codecName:e.str(),quality:e.b()}}static voiceData(e){let t=e.ub(),s=e.us();return{playerIndex:t,data:e.arrx(s,B.UByte)}}static sendExtraInfo(e){return{fallbackDir:e.str(),canCheat:e.ub()}}static timeScale(e){return{timeScale:e.f()}}static resourceLocation(e){return{url:e.str()}}static sendCvarValue(e){return{name:e.str()}}static sendCvarValue2(e){return{requestId:e.ui(),name:e.str()}}static read(e,t,s){if(0===t)return null;const i=ne.handlers[t];return i?i(e,s):null}};let ae=ne;var oe,le;ae.handlers=[ne.bad,ne.nop,ne.disconnect,ne.event,ne.version,ne.setView,ne.sound,ne.time,ne.print,ne.stuffText,ne.setAngle,ne.serverInfo,ne.lightStyle,ne.updateUserInfo,ne.deltaDescription,ne.clientData,ne.stopSound,ne.pings,ne.particle,ne.damage,ne.spawnStatic,ne.eventReliable,ne.spawnBaseLine,ne.tempEntity,ne.setPause,ne.signOnNum,ne.centerPrint,ne.killedMonster,ne.foundSecret,ne.spawnStaticSound,ne.intermission,ne.finale,ne.cdTrack,ne.restore,ne.cutscene,ne.weaponAnim,ne.decalName,ne.roomType,ne.addAngle,ne.newUserMsg,ne.packetEntities,ne.deltaPacketEntities,ne.choke,ne.resourceList,ne.newMoveVars,ne.resourceRequest,ne.customization,ne.crosshairAngle,ne.soundFade,ne.fileTxferFailed,ne.hltv,ne.director,ne.voiceInit,ne.voiceData,ne.sendExtraInfo,ne.timeScale,ne.resourceLocation,ne.sendCvarValue,ne.sendCvarValue2],oe=ae||(ae={}),(le=oe.SVC||(oe.SVC={}))[le.BAD=0]="BAD",le[le.NOP=1]="NOP",le[le.DISCONNECT=2]="DISCONNECT",le[le.EVENT=3]="EVENT",le[le.VERSION=4]="VERSION",le[le.SETVIEW=5]="SETVIEW",le[le.SOUND=6]="SOUND",le[le.TIME=7]="TIME",le[le.PRINT=8]="PRINT",le[le.STUFFTEXT=9]="STUFFTEXT",le[le.SETANGLE=10]="SETANGLE",le[le.SERVERINFO=11]="SERVERINFO",le[le.LIGHTSTYLE=12]="LIGHTSTYLE",le[le.UPDATEUSERINFO=13]="UPDATEUSERINFO",le[le.DELTADESCRIPTION=14]="DELTADESCRIPTION",le[le.CLIENTDATA=15]="CLIENTDATA",le[le.STOPSOUND=16]="STOPSOUND",le[le.PINGS=17]="PINGS",le[le.PARTICLE=18]="PARTICLE",le[le.DAMAGE=19]="DAMAGE",le[le.SPAWNSTATIC=20]="SPAWNSTATIC",le[le.EVENT_RELIABLE=21]="EVENT_RELIABLE",le[le.SPAWNBASELINE=22]="SPAWNBASELINE",le[le.TEMPENTITY=23]="TEMPENTITY",le[le.SETPAUSE=24]="SETPAUSE",le[le.SIGNONNUM=25]="SIGNONNUM",le[le.CENTERPRINT=26]="CENTERPRINT",le[le.KILLEDMONSTER=27]="KILLEDMONSTER",le[le.FOUNDSECRET=28]="FOUNDSECRET",le[le.SPAWNSTATICSOUND=29]="SPAWNSTATICSOUND",le[le.INTERMISSION=30]="INTERMISSION",le[le.FINALE=31]="FINALE",le[le.CDTRACK=32]="CDTRACK",le[le.RESTORE=33]="RESTORE",le[le.CUTSCENE=34]="CUTSCENE",le[le.WEAPONANIM=35]="WEAPONANIM",le[le.DECALNAME=36]="DECALNAME",le[le.ROOMTYPE=37]="ROOMTYPE",le[le.ADDANGLE=38]="ADDANGLE",le[le.NEWUSERMSG=39]="NEWUSERMSG",le[le.PACKETENTITIES=40]="PACKETENTITIES",le[le.DELTAPACKETENTITIES=41]="DELTAPACKETENTITIES",le[le.CHOKE=42]="CHOKE",le[le.RESOURCELIST=43]="RESOURCELIST",le[le.NEWMOVEVARS=44]="NEWMOVEVARS",le[le.RESOURCEREQUEST=45]="RESOURCEREQUEST",le[le.CUSTOMIZATION=46]="CUSTOMIZATION",le[le.CROSSHAIRANGLE=47]="CROSSHAIRANGLE",le[le.SOUNDFADE=48]="SOUNDFADE",le[le.FILETXFERFAILED=49]="FILETXFERFAILED",le[le.HLTV=50]="HLTV",le[le.DIRECTOR=51]="DIRECTOR",le[le.VOICEINIT=52]="VOICEINIT",le[le.VOICEDATA=53]="VOICEDATA",le[le.SENDEXTRAINFO=54]="SENDEXTRAINFO",le[le.TIMESCALE=55]="TIMESCALE",le[le.RESOURCELOCATION=56]="RESOURCELOCATION",le[le.SENDCVARVALUE=57]="SENDCVARVALUE",le[le.SENDCVARVALUE2=58]="SENDCVARVALUE2";const he=e=>({demoProtocol:e.ui(),netProtocol:e.ui(),mapName:e.nstr(260),modName:e.nstr(260),mapCrc:e.i(),dirOffset:e.ui()}),ce=(e,t)=>{e.seek(t);let s=e.ui(),i=[];for(let t=0;t<s;++t)i.push({id:e.ui(),name:e.nstr(64),flags:e.ui(),cdTrack:e.i(),time:e.f(),frames:e.ui(),offset:e.ui(),length:e.ui()});return i},de=(e,t,s)=>{let i={type:e.ub(),time:e.f(),tick:e.ui()};switch(i.type){case 0:case 1:e.skip(4),i.camera={position:[e.f(),e.f(),e.f()],orientation:[e.f(),e.f(),e.f()]},e.skip(436),i.data=((e,t,s)=>{let i=e.ui(),r=e.tell()+i,n=[];for(;e.tell()<r;){let i=e.ub();if(1===i)continue;if(i>=64){s[i]&&s[i].size>-1?e.skip(s[i].size):e.skip(e.ub());continue}let a=ae.read(e,i,t);a?(39===i&&(s[a.index]=a),n.push({type:i,data:a})):e.seek(r)}return e.seek(r),n})(e,t,s);break;case 2:break;case 3:i.command=e.nstr(64);break;case 4:e.skip(32);break;case 5:break;case 6:e.skip(84);break;case 7:e.skip(8);break;case 8:i.sound={channel:e.i(),sample:e.nstr(e.ui()),attenuation:e.f(),volume:e.f(),flags:e.ui(),pitch:e.i()};break;case 9:e.skip(e.ui());break;default:i.error=!0}return i};class ue{constructor(e,t){this.header=e,this.mapName=this.header.mapName,this.directories=t}static parseFromArrayBuffer(e){let t=new G(e);if("HLDEMO"!==t.nstr(8))throw new Error("Invalid replay format");let s={};s.demoProtocol=t.ui(),s.netProtocol=t.ui(),s.mapName=t.nstr(260),s.modName=t.nstr(260),s.mapCrc=t.i(),s.dirOffset=t.ui(),t.seek(s.dirOffset);let i=t.ui(),r=[];for(let e=0;e<i;++e)r.push({id:t.ui(),name:t.nstr(64),flags:t.ui(),cdTrack:t.i(),time:t.f(),frames:t.ui(),offset:t.ui(),length:t.ui(),macros:[]});for(let e=0;e<r.length;++e){t.seek(r[e].offset);let s=!1;for(;!s;){let i={type:t.b(),time:t.f(),frame:t.ui()};switch(i.type){case 0:case 1:t.skip(4),i.camera={position:[t.f(),t.f(),t.f()],orientation:[t.f(),t.f(),t.f()]},t.skip(436),t.skip(t.ui());break;case 2:break;case 3:i.command=t.nstr(64);break;case 4:t.skip(32);break;case 5:s=!0;break;case 6:t.skip(84);break;case 7:t.skip(8);break;case 8:t.skip(4),t.skip(t.ui()+16);break;case 9:t.skip(t.ui());break;default:{const e=Number(t.tell()-9).toString(16),s=[`Unexpected macro (${i.type})`,` at offset = ${e}.`].join("");throw new Error(s)}}r[e].macros.push(i)}}return new ue(s,r)}static parseFullFromArrayBuffer(e){let t=new G(e);if("HLDEMO"!==t.nstr(8))throw new Error("Invalid replay format");let s={};s.demoProtocol=t.ui(),s.netProtocol=t.ui(),s.mapName=t.nstr(260),s.modName=t.nstr(260),s.mapCrc=t.i(),s.dirOffset=t.ui(),t.seek(s.dirOffset);let i=t.ui(),r=[];for(let e=0;e<i;++e)r.push({id:t.ui(),name:t.nstr(64),flags:t.ui(),cdTrack:t.i(),time:t.f(),frames:t.ui(),offset:t.ui(),length:t.ui(),macros:[]});let n=te(),a=[];for(let e=0;e<r.length;++e){t.seek(r[e].offset);let s=!1;for(;!s;){let i={type:t.b(),time:t.f(),frame:t.ui()};switch(i.type){case 0:case 1:{t.skip(4),i.camera={position:[t.f(),t.f(),t.f()],orientation:[t.f(),t.f(),t.f()],forward:[t.f(),t.f(),t.f()],right:[t.f(),t.f(),t.f()],up:[t.f(),t.f(),t.f()]},i.RefParams={frametime:t.f(),time:t.f(),intermission:t.i(),paused:t.i(),spectator:t.i(),onground:t.i(),waterlevel:t.i(),velocity:[t.f(),t.f(),t.f()],origin:[t.f(),t.f(),t.f()],viewHeight:[t.f(),t.f(),t.f()],idealPitch:t.f(),viewAngles:[t.f(),t.f(),t.f()],health:t.i(),crosshairAngle:[t.f(),t.f(),t.f()],viewSize:t.f(),punchAngle:[t.f(),t.f(),t.f()],maxClients:t.i(),viewEntity:t.i(),playerCount:t.i(),maxEntities:t.i(),demoPlayback:t.i(),hardware:t.i(),smoothing:t.i(),ptr_cmd:t.i(),ptr_movevars:t.i(),viewport:[t.i(),t.i(),t.i(),t.i()],nextView:t.i(),onlyClientDraw:t.i()},i.UserCmd={lerp_msec:t.s(),msec:t.ub(),UNUSED1:t.ub(),viewAngles:[t.f(),t.f(),t.f()],forwardMove:t.f(),sideMove:t.f(),upMove:t.f(),lightLevel:t.b(),UNUSED2:t.ub(),buttons:t.us(),impulse:t.b(),weaponSelect:t.b(),UNUSED:t.s(),impactIndex:t.i(),impactPosition:[t.f(),t.f(),t.f()]},i.MoveVars={gravity:t.f(),stopSpeed:t.f(),maxSpeed:t.f(),spectatorMaxSpeed:t.f(),acceleration:t.f(),airAcceleration:t.f(),waterAcceleration:t.f(),friction:t.f(),edgeFriction:t.f(),waterFriction:t.f(),entityGravity:t.f(),bounce:t.f(),stepSize:t.f(),maxVelocity:t.f(),zMax:t.f(),waveHeight:t.f(),footsteps:t.i(),skyName:t.nstr(32),rollAngle:t.f(),rollSpeed:t.f(),skyColor:[t.f(),t.f(),t.f()],skyVec:[t.f(),t.f(),t.f()]},i.view=[t.f(),t.f(),t.f()],i.viewModel=t.i(),i.incoming_sequence=t.i(),i.incoming_acknowledged=t.i(),i.incoming_reliable_acknowledged=t.i(),i.incoming_reliable_sequence=t.i(),i.outgoing_sequence=t.i(),i.reliable_sequence=t.i(),i.last_reliable_sequence=t.i();let e=t.ui()+t.tell();for(i.frameData=[];t.tell()<e;){let s=t.ub();if(1===s)continue;if(s>=64){a[s]&&a[s].size>-1?t.skip(a[s].size):t.skip(t.ub());continue}let r=ae.read(t,s,n);r?(39===s&&(a[r.index]=r),i.frameData.push({type:s,frameData:r})):t.seek(e)}t.seek(e);break}case 2:break;case 3:i.command=t.nstr(64);break;case 4:i.clientData={position:[t.f(),t.f(),t.f()],rotation:[t.f(),t.f(),t.f()],weaponFlags:t.ui(),fov:t.f()};break;case 5:s=!0;break;case 6:i.event={flags:t.ui(),index:t.ui(),delay:t.f(),args:{flags:t.ui(),entityIndex:t.ui(),position:[t.f(),t.f(),t.f()],rotation:[t.f(),t.f(),t.f()],velocity:[t.f(),t.f(),t.f()],ducking:t.ui(),fparam1:t.f(),fparam2:t.f(),iparam1:t.i(),iparam2:t.i(),bparam1:t.i(),bparam2:t.i()}};break;case 7:i.weaponAnimation={animation:t.i(),body:t.i()};break;case 8:i.sound={channel:t.i(),sample:t.nstr(t.ui()),attenuation:t.f(),volume:t.f(),flags:t.ui(),pitch:t.i()};break;case 9:t.skip(t.ui());break;default:{const e=Number(t.tell()-9).toString(16),s=`Unexpected macro (${i.type}) at offset = ${e}`;throw new Error(s)}}r[e].macros.push(i)}}return new ue(s,r)}static parseIntoChunks(e){let t=new G(e);if(!(e=>"HLDEMO"===e.nstr(8))(t))throw new Error("Invalid replay file format");let s,i,r,n,a,o=[],l=te(),h=[],c=he(t),d=ce(t,c.dirOffset),u=new K;for(a=d[0].offset+d[0].length,t.seek(d[0].offset);t.tell()<a;){let e=de(t,l,h);if(u.feedFrame(e),e.error)throw new Error("Encountered error while reading replay");if(e.type<2){let t=e.data.find((e=>e.type===ae.SVC.SERVERINFO));t&&(s=new Y(t.data.mapFileName),o.push(s));let i=e.data.find((e=>e.type===ae.SVC.RESOURCELIST));i&&s&&s.setResources(i.data)}}if(!(s instanceof Y))throw new Error("Error while parsing replay.");for(n=t.tell(),i=new j(u,0),s.addChunk(i),a=d[1].offset+d[1].length,t.seek(d[1].offset);;){let e=t.tell();if(e>=a){let s=r.time-i.startTime;i.timeLength=s;let a=e-n;t.seek(n),i.setData(t.arrx(a,B.UByte)),t.seek(e);break}let c=de(t,l,h);if(u.feedFrame(c),r=c,c.error)throw new Error("Encountered error while reading replay");if(c.type<2){let a=c.data.find((e=>e.type===ae.SVC.SERVERINFO));if(a){s=new Y(a.data.mapFileName),o.push(s);let l=r.time-i.startTime;i.timeLength=l;let h=e-n,d=t.tell();t.seek(n),i.setData(t.arrx(h,B.UByte)),t.seek(d),n=e,i=new j(u,c.time),s.addChunk(i)}let l=c.data.find((e=>e.type===ae.SVC.RESOURCELIST));if(l&&s.setResources(l.data),a)continue;for(let e=0;e<c.data.length;++e){let t=c.data[e];if(t.type===ae.SVC.SOUND||t.type===ae.SVC.SPAWNSTATICSOUND){let e=s.resources.sounds.find((e=>e.index===t.data.soundIndex));e&&(e.used=!0)}else if(t.type===ae.SVC.STUFFTEXT){let e=s.resources.sounds,i=t.data.commands;for(let t=0;t<i.length;++t){let s=i[t],r=s.func;if(("speak"===r||"spk"===r)&&1===s.params.length){let t=s.params[0]+".wav",i=e.find((e=>e.name===t));i&&(i.used=!0)}}}}}else if(8===c.type){let e=s.resources.sounds.find((e=>e.name===c.sound.sample));e&&(e.used=!0)}if(i.startTime+10<c.time){let r=e-n,a=t.tell();t.seek(n),i.setData(t.arrx(r,B.UByte)),t.seek(a),n=e,i=new j(u,c.time),s.addChunk(i)}}return{length:d[1].time,maps:o,deltaDecoders:l,customMessages:h}}static readHeader(e){return he(e)}static readDirectories(e,t){return ce(e,t)}static readFrame(e,t,s){return de(e,t,s)}static readFrameData(e,t,s){return de(e,t,s)}}var pe,fe,me,ge,Ee,xe;(fe=pe||(pe={}))[fe.VP_PARALLEL_UPRIGHT=0]="VP_PARALLEL_UPRIGHT",fe[fe.FACING_UPRIGHT=1]="FACING_UPRIGHT",fe[fe.VP_PARALLEL=2]="VP_PARALLEL",fe[fe.ORIENTED=3]="ORIENTED",fe[fe.VP_PARALLEL_ORIENTED=4]="VP_PARALLEL_ORIENTED",(ge=me||(me={}))[ge.SPR_NORMAL=0]="SPR_NORMAL",ge[ge.SPR_ADDITIVE=1]="SPR_ADDITIVE",ge[ge.SPR_INDEXALPHA=2]="SPR_INDEXALPHA",ge[ge.SPR_ALPHTEST=3]="SPR_ALPHTEST",(xe=Ee||(Ee={}))[xe.SYNCHRONIZED=0]="SYNCHRONIZED",xe[xe.RANDOM=1]="RANDOM";class ye{constructor(e,t){this.header=e,this.frames=t}static parse(e){const t=new G(e);if("IDSP"!==t.nstr(4))throw new Error("Invalid sprite file format");const s={version:t.i(),type:t.i(),alphaType:t.i(),radius:t.f(),width:t.i(),height:t.i(),frameCount:t.i(),beamLength:t.f(),syncType:t.i()},i=t.s(),r=t.arrx(3*i,B.UByte),n=[];for(let e=0;e<s.frameCount;++e){const e={group:t.i(),position:[t.i(),t.i()],width:t.i(),height:t.i(),data:new Uint8Array(s.width*s.height*4)},i=t.arrx(s.width*s.height,B.UByte);e.data=3===s.alphaType?W(i,r):H(i,r),n.push(e)}return new ye(s,n)}}class be{constructor(e,t,s,i,r){this.skies=[],this.sprites={},this.name=e,this.entities=t,this.textures=s,this.models=i,this.lightmap=r}}const _e=class{constructor(e){this.block=new Uint16Array(_e.TEXTURE_SIZE),this.lightmap=e,this.texture=new Uint8Array(_e.TEXTURE_SIZE*_e.TEXTURE_SIZE*4),this.texture[this.texture.length-4]=255,this.texture[this.texture.length-3]=255,this.texture[this.texture.length-2]=255,this.texture[this.texture.length-1]=255}static init(e){return new _e(e)}getTexture(){return this.texture}processFace(e,t,s){const i=this.getDimensions(e),r=this.readLightmap(s,i.width,i.height);if(r)for(let s=0;s<e.length/7;++s){let n=e[7*s]*t.s[0]+e[7*s+1]*t.s[1]+e[7*s+2]*t.s[2]+t.sShift-i.minU;n+=16*r.x+8,n/=16*_e.TEXTURE_SIZE;let a=e[7*s]*t.t[0]+e[7*s+1]*t.t[1]+e[7*s+2]*t.t[2]+t.tShift-i.minV;a+=16*r.y+8,a/=16*_e.TEXTURE_SIZE,e[7*s+5]=n,e[7*s+6]=a}}getDimensions(e){let t=Math.floor(e[3]),s=Math.floor(e[4]),i=Math.floor(e[3]),r=Math.floor(e[4]);for(let n=1;n<e.length/7;++n)Math.floor(e[7*n+3])<t&&(t=Math.floor(e[7*n+3])),Math.floor(e[7*n+4])<s&&(s=Math.floor(e[7*n+4])),Math.floor(e[7*n+3])>i&&(i=Math.floor(e[7*n+3])),Math.floor(e[7*n+4])>r&&(r=Math.floor(e[7*n+4]));return{width:Math.ceil(i/16)-Math.floor(t/16)+1,height:Math.ceil(r/16)-Math.floor(s/16)+1,minU:Math.floor(t),minV:Math.floor(s)}}readLightmap(e,t,s){if(s<=0||t<=0)return null;const i=this.findFreeSpace(t,s);if(i){const r=[i.x,i.y],n=[t,s],a=[_e.TEXTURE_SIZE,_e.TEXTURE_SIZE],o=t*s;for(let t=0;t<o;++t){const s=r[1]*a[0]+r[0]+a[0]*Math.floor(t/n[0])+t%n[0];this.texture[4*s]=Math.min(255,2*this.lightmap[e+3*t]),this.texture[4*s+1]=Math.min(255,2*this.lightmap[e+3*t+1]),this.texture[4*s+2]=Math.min(255,2*this.lightmap[e+3*t+2]),this.texture[4*s+3]=255}}return i}findFreeSpace(e,t){let s=0,i=0,r=_e.TEXTURE_SIZE;for(let t=0;t<this.block.length-e;++t){let n,a=0;for(n=0;n<e&&!(this.block[t+n]>=r);++n)this.block[t+n]>a&&(a=this.block[t+n]);n===e&&(s=t,i=r=a)}if(r+t>_e.TEXTURE_SIZE)return null;for(let i=0;i<e;++i)this.block[s+i]=r+t;return{x:s,y:i}}};let we=_e;var Te,ke,ve,Se;we.TEXTURE_SIZE=1024,(ke=Te||(Te={}))[ke.Entities=0]="Entities",ke[ke.Planes=1]="Planes",ke[ke.Textures=2]="Textures",ke[ke.Vertices=3]="Vertices",ke[ke.Visibility=4]="Visibility",ke[ke.Nodes=5]="Nodes",ke[ke.TexInfo=6]="TexInfo",ke[ke.Faces=7]="Faces",ke[ke.Lighting=8]="Lighting",ke[ke.ClipNodes=9]="ClipNodes",ke[ke.Leaves=10]="Leaves",ke[ke.MarkSurfaces=11]="MarkSurfaces",ke[ke.Edges=12]="Edges",ke[ke.SurfEdges=13]="SurfEdges",ke[ke.Models=14]="Models";(Se=ve||(ve={}))[Se.Loading=1]="Loading",Se[Se.Skipped=2]="Skipped",Se[Se.Error=3]="Error",Se[Se.Done=4]="Done";class Ae{constructor(e){this.name=e,this.progress=0,this.status=1,this.data=null}isLoading(){return 1===this.status}skip(){this.status=2}isSkipped(){return 2===this.status}error(){this.status=3}isError(){return 3===this.status}done(e){this.status=4,this.data=e}isDone(){return 4===this.status}}class Ie extends Ae{constructor(){super(...arguments),this.type="replay"}}class Me extends Ae{constructor(){super(...arguments),this.type="bsp"}}class Re extends Ae{constructor(){super(...arguments),this.type="sky"}}class Le extends Ae{constructor(){super(...arguments),this.type="wad"}}class Ce extends Ae{constructor(){super(...arguments),this.type="sound"}}class Pe extends Ae{constructor(){super(...arguments),this.type="sprite"}}class Ne extends EventTarget{constructor(e){super(),this.sprites={},this.config=e,this.replay=void 0,this.map=void 0,this.skies=[],this.wads=[],this.sounds=[]}clear(){this.replay=void 0,this.map=void 0,this.skies.length=0,this.wads.length=0,this.sounds.length=0,this.sprites={}}checkStatus(){if(this.replay&&!this.replay.isDone())return;if(this.map&&!this.map.isDone())return;for(let e=0;e<this.skies.length;++e)if(this.skies[e].isLoading())return;for(let e=0;e<this.wads.length;++e)if(this.wads[e].isLoading())return;for(let e=0;e<this.sounds.length;++e)if(this.sounds[e].isLoading())return;const e=Object.entries(this.sprites);for(let t=0;t<e.length;++t)if(e[t][1].isLoading())return;this.dispatchEvent(R("loadAll",{detail:{loader:this}}))}readFileAsync(e){return new Promise(((t,s)=>{let i=new FileReader;i.onload=()=>{t(i.result)},i.onerror=s,i.readAsArrayBuffer(e)}))}async processFile(e){try{return await this.readFileAsync(e)}catch(t){console.error("Could not read file: ",e,t)}}async load(e){console.log(e);const t=function(e){const t=e.lastIndexOf("/"),s=e.lastIndexOf(".");return t<s?e.slice(s):""}(e);".dem"===t?await this.loadReplay(e):".bsp"===t?await this.loadMap(e):console.error("Invalid file extension",e)}async loadReplay(e){let t;this.replay=new Ie(e),this.dispatchEvent(R("loadstart",{detail:{item:this.replay}}));const s=this.config.paths.replays.find((t=>t.name===e));if(s?t=await this.processFile(s):(this.replay.error(),console.error("Could not load: ",e),this.checkStatus()),this.replay.isError())return;const i=await ue.parseIntoChunks(t);this.replay.done(i),await this.loadMap(i.maps[0].name+".bsp");i.maps[0].resources.sounds.forEach((e=>{const t=e.name.split("/"),s=t[t.length-1];e.used&&this.loadSound(s,e.index)})),this.dispatchEvent(R("load",{detail:{item:this.replay}})),this.checkStatus()}async loadMap(e){let t;this.map=new Me(e),this.dispatchEvent(R("loadstart",{detail:{item:this.map}}));const s=this.config.paths.maps.find((t=>t.name===e));if(s?t=await this.processFile(s):(this.map.error(),console.error("Could not load: ",e),this.checkStatus()),this.map.isError())return;const i=class{static parse(e,t){const s=new G(t);if(30!==s.ui())throw new Error("Invalid map version");const i=[];for(let e=0;e<15;++e)i.push({offset:s.ui(),length:s.ui()});const r=this.loadEntities(s,i[0].offset,i[0].length),n=this.loadTextures(s,i[2].offset),a=this.loadModels(s,i[14].offset,i[14].length),o=this.loadFaces(s,i[7].offset,i[7].length),l=this.loadEdges(s,i[12].offset,i[12].length),h=this.loadSurfEdges(s,i[13].offset,i[13].length),c=this.loadVertices(s,i[3].offset,i[3].length),d=this.loadTexInfo(s,i[6].offset,i[6].length),u=this.loadLightmap(s,i[8].offset,i[8].length),p=we.init(u),f=function(e,t,s,i,r,n,a,o){const l=[];for(let h=0;h<e.length;++h){const c=e[h],d=[],u=new Float32Array(3),p=new Float32Array(3),f=new Float32Array(3),m=new Float32Array(2),g=new Float32Array(2),E=new Float32Array(2),x=new Float32Array(2),y=new Float32Array(2),b=new Float32Array(2);let _=0===h?[0,0,0]:[0,0,0].map(((e,t)=>(c.maxs[t]-c.mins[t])/2+c.mins[t]));for(let e=c.firstFace;e<c.firstFace+c.faceCount;++e){const l={buffer:new Float32Array(21*(t[e].edgeCount-2)),textureIndex:-1},h=n[t[e].textureInfo],c=a[h.textureIndex],w=i.slice(t[e].firstEdge,t[e].firstEdge+t[e].edgeCount),T=s[Math.abs(w[0])][w[0]>0?0:1];u[0]=r[T][0],u[1]=r[T][1],u[2]=r[T][2],m[0]=u[0]*h.s[0]+u[1]*h.s[1]+u[2]*h.s[2]+h.sShift,m[1]=u[0]*h.t[0]+u[1]*h.t[1]+u[2]*h.t[2]+h.tShift,x[0]=0,x[1]=0;const k=s[Math.abs(w[1])][w[1]>0?0:1];p[0]=r[k][0],p[1]=r[k][1],p[2]=r[k][2],g[0]=p[0]*h.s[0]+p[1]*h.s[1]+p[2]*h.s[2]+h.sShift,g[1]=p[0]*h.t[0]+p[1]*h.t[1]+p[2]*h.t[2]+h.tShift,y[0]=0,y[1]=.999;let v=0;for(let i=2;i<t[e].edgeCount;++i){const e=s[Math.abs(w[i])][w[i]>0?0:1];f[0]=r[e][0],f[1]=r[e][1],f[2]=r[e][2],E[0]=f[0]*h.s[0]+f[1]*h.s[1]+f[2]*h.s[2]+h.sShift,E[1]=f[0]*h.t[0]+f[1]*h.t[1]+f[2]*h.t[2]+h.tShift,b[0]=.999,b[1]=.999,l.buffer[v++]=u[0],l.buffer[v++]=u[1],l.buffer[v++]=u[2],l.buffer[v++]=m[0],l.buffer[v++]=m[1],l.buffer[v++]=x[0],l.buffer[v++]=x[1],l.buffer[v++]=p[0],l.buffer[v++]=p[1],l.buffer[v++]=p[2],l.buffer[v++]=g[0],l.buffer[v++]=g[1],l.buffer[v++]=y[0],l.buffer[v++]=y[1],l.buffer[v++]=f[0],l.buffer[v++]=f[1],l.buffer[v++]=f[2],l.buffer[v++]=E[0],l.buffer[v++]=E[1],l.buffer[v++]=b[0],l.buffer[v++]=b[1],p[0]=f[0],p[1]=f[1],p[2]=f[2],g[0]=E[0],g[1]=E[1],y[0]=b[0],y[1]=b[1]}0!==h.flags&&-65536!==h.flags||o.processFace(l.buffer,h,t[e].lightmapOffset),l.textureIndex=h.textureIndex;for(let e=0;e<l.buffer.length/7;++e)l.buffer[7*e]-=_[0],l.buffer[7*e+1]-=_[1],l.buffer[7*e+2]-=_[2],l.buffer[7*e+3]/=c.width,l.buffer[7*e+4]/=c.height;d.push(l)}l.push({origin:_,faces:d})}return l}(a,o,l,h,c,d,n,p);return new be(e,r,n,f,{width:we.TEXTURE_SIZE,height:we.TEXTURE_SIZE,data:p.getTexture()})}static loadFaces(e,t,s){e.seek(t);const i=[];for(let t=0;t<s/20;++t)i.push({plane:e.us(),planeSide:e.us(),firstEdge:e.ui(),edgeCount:e.us(),textureInfo:e.us(),styles:[e.ub(),e.ub(),e.ub(),e.ub()],lightmapOffset:e.ui()});return i}static loadModels(e,t,s){e.seek(t);const i=[];for(let t=0;t<s/64;++t)i.push({mins:[e.f(),e.f(),e.f()],maxs:[e.f(),e.f(),e.f()],origin:[e.f(),e.f(),e.f()],headNodes:[e.i(),e.i(),e.i(),e.i()],visLeaves:e.i(),firstFace:e.i(),faceCount:e.i()});return i}static loadEdges(e,t,s){e.seek(t);const i=[];for(let t=0;t<s/4;++t)i.push([e.us(),e.us()]);return i}static loadSurfEdges(e,t,s){e.seek(t);const i=[];for(let t=0;t<s/4;++t)i.push(e.i());return i}static loadVertices(e,t,s){e.seek(t);const i=[];for(let t=0;t<s/12;++t)i.push([e.f(),e.f(),e.f()]);return i}static loadTexInfo(e,t,s){e.seek(t);const i=[];for(let t=0;t<s/40;++t)i.push({s:[e.f(),e.f(),e.f()],sShift:e.f(),t:[e.f(),e.f(),e.f()],tShift:e.f(),textureIndex:e.i(),flags:e.i()});return i}static loadLightmap(e,t,s){return e.seek(t),e.arrx(s,B.UByte)}static loadTextureData(e){const t=e.nstr(16),s=e.ui(),i=e.ui(),r=!e.ui();if(r){const e=new Uint8Array(4);return e[0]=e[1]=e[2]=e[3]=255,{name:t,width:s,height:i,data:e,isExternal:r}}{e.skip(12);const n=s*i,a=e.arrx(n,B.UByte);e.skip(n/64*21),e.skip(2);const o=e.arrx(768,B.UByte);return{name:t,width:s,height:i,data:"{"===t[0]?W(a,o):H(a,o),isExternal:r}}}static loadTextures(e,t){e.seek(t);const s=e.ui(),i=[];for(let t=0;t<s;++t)i.push(e.ui());const r=[];for(let n=0;n<s;++n)4294967295===i[n]?r.push({name:"ERROR404",width:1,height:1,data:new Uint8Array([0,255,0,255]),isExternal:!1}):(e.seek(t+i[n]),r.push(this.loadTextureData(e)));return r}static loadEntities(e,t,s){e.seek(t);const i=function(e){let t=0,s="",i="";const r=[];for(let n=0;n<e.length;++n){const a=e[n];switch(t){case 0:if(/\s/.test(a))continue;if("{"!==a)return[];r.push({}),t=1;break;case 1:if(/\s/.test(a))continue;if("}"===a)t=0;else{if('"'!==a)return[];s="",t=2}break;case 2:'"'===a?t=3:s+=a;break;case 3:if(/\s/.test(a))continue;'"'===a&&(i="",t=4);break;case 4:'"'===a?(r[r.length-1][s]=i,t=1):i+=a}}return r}(e.nstr(s)),r=["origin","angles","_diffuse_light","_light","rendercolor","avelocity"],n=["renderamt","rendermode","scale"],a=i[0];return"worldspawn"===a.classname&&(a.model="*0",a.wad=a.wad||"",a.wad=a.wad.split(";").filter((e=>e.length)).map((e=>e.replace(/\\/g,"/"))).map((e=>{return(t=e).slice(t.lastIndexOf("/")+1).replace(s||"","");var t,s}))),i.forEach((e=>{e.model&&(void 0===e.renderamt&&(e.renderamt=0),void 0===e.rendermode&&(e.rendermode=0),void 0===e.renderfx&&(e.renderfx=0),void 0===e.rendercolor&&(e.rendercolor="0 0 0")),r.forEach((t=>{e[t]&&(e[t]=e[t].split(" ").map((e=>Number.parseFloat(e))))})),n.forEach((t=>{e[t]&&(e[t]=Number.parseFloat(e[t]))}))})),i}}.parse(e,t);this.map.done(i),i.entities.map((e=>{if("string"==typeof e.model&&e.model.indexOf(".spr")>-1)return e.model})).filter(((e,t,s)=>e&&s.indexOf(e)===t)).forEach((e=>e&&this.loadSprite(e)));const r=i.entities[0].skyname;if(r){["bk","dn","ft","lf","rt","up"].map((e=>`${r}${e}`)).forEach((e=>{this.loadSky(e)}))}if(i.textures.find((e=>e.isExternal))){const e=i.entities[0].wad.map((e=>this.loadWad(e)));await Promise.all(e)}this.dispatchEvent(R("load",{detail:{item:this.map}})),this.checkStatus(),this.dispatchEvent(R("loadAll",{detail:{loader:this}}))}async loadSprite(e){let t;const s=new Pe(e);this.sprites[e]=s,this.dispatchEvent(R("loadstart",{detail:{item:s}}));const i=e.split("/"),r=i[i.length-1],n=this.config.paths.sprites.find((e=>e.name===r));if(n?t=await this.processFile(n):(s.error(),console.error("Could not load: ",r),this.checkStatus()),s.isError())return;const a=ye.parse(t);s.done(a),this.dispatchEvent(R("load",{detail:{item:s}})),this.checkStatus()}async loadSky(e){let t;const s=new Re(e);this.skies.push(s),this.dispatchEvent(R("loadstart",{detail:{item:s}}));const i=(e,t)=>{s.progress=t,this.dispatchEvent(R("progress",{detail:{item:s}}))},r=new RegExp(e+".tga","i"),n=this.config.paths.skies.find((e=>e.name.match(r)));if(t=n?await this.processFile(n):await function(e,t){let s=t.method||"GET",i=t.isBinary,r=t.progressCallback;if(!e)throw new Error("Url parameter missing");return new Promise(((t,n)=>{let a=new XMLHttpRequest;i&&(a.responseType="arraybuffer"),i&&r&&a.addEventListener("progress",(e=>{if(e.lengthComputable)r(a,e.loaded/e.total);else{let t=a.getResponseHeader("content-length"),s=0;t&&(s=parseFloat(t));let i=a.getResponseHeader("content-encoding");if(s&&i&&i.indexOf("gzip")>-1){s*=4;let t=Math.min(.99,e.loaded/s);r(a,t)}else r(a,0)}})),a.addEventListener("readystatechange",(e=>{4===e.target.readyState&&(200===e.target.status?(r&&r(a,1),t(e.target.response)):n({status:e.target.status}))})),a.open(s,e,!0),a.send()}))}("missing.tga",{method:"GET",isBinary:!0,progressCallback:i}).catch((e=>{s.error(),console.error(e,s),this.checkStatus()})),s.isError())return;const a=X.parse(t,e);s.done(a),this.dispatchEvent(R("load",{detail:{item:s}})),this.checkStatus()}async loadWad(e){let t;const s=new Le(e);this.wads.push(s),this.dispatchEvent(R("loadstart",{detail:{item:s}}));const i=new RegExp(e,"i"),r=this.config.paths.wads.find((e=>e.name.match(i)));if(r?t=await this.processFile(r):(s.error(),console.error("Could not load: ",e),this.checkStatus()),s.isError())return;const n=await $.parse(t);if(s.done(n),!this.map||!this.map.data)return;const a=this.map.data;n.entries.forEach((e=>{"texture"===e.type&&a.textures.forEach((t=>{var s,i;s=e.name,i=t.name,s.toLowerCase()===i.toLowerCase()&&(t.width=e.width,t.height=e.height,t.data=e.data)}))})),this.dispatchEvent(R("loadstart",{detail:{item:s}})),this.checkStatus()}async loadSound(e,t){let s,i;const r=new Ce(e);this.sounds.push(r),this.dispatchEvent(R("loadstart",{detail:{item:r}}));const n=this.config.paths.sounds.find((t=>t.name===e));n?(s=await this.processFile(n),i=await O.create(s).catch((e=>{r.error(),console.error(e,r),this.checkStatus()}))):(r.error(),console.error("Could not load: ",e),this.checkStatus()),i&&!r.isError()&&(i.index=t,i.name=e,r.done(i),this.dispatchEvent(R("loadstart",{detail:{item:r}})),this.checkStatus())}}var De="undefined"!=typeof Float32Array?Float32Array:Array,Ue=Math.PI/180;function Fe(e){return e*Ue}function Oe(){var e=new De(16);return De!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Be(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Ve(e,t,s){var i=s[0],r=s[1],n=s[2],a=void 0,o=void 0,l=void 0,h=void 0,c=void 0,d=void 0,u=void 0,p=void 0,f=void 0,m=void 0,g=void 0,E=void 0;return t===e?(e[12]=t[0]*i+t[4]*r+t[8]*n+t[12],e[13]=t[1]*i+t[5]*r+t[9]*n+t[13],e[14]=t[2]*i+t[6]*r+t[10]*n+t[14],e[15]=t[3]*i+t[7]*r+t[11]*n+t[15]):(a=t[0],o=t[1],l=t[2],h=t[3],c=t[4],d=t[5],u=t[6],p=t[7],f=t[8],m=t[9],g=t[10],E=t[11],e[0]=a,e[1]=o,e[2]=l,e[3]=h,e[4]=c,e[5]=d,e[6]=u,e[7]=p,e[8]=f,e[9]=m,e[10]=g,e[11]=E,e[12]=a*i+c*r+f*n+t[12],e[13]=o*i+d*r+m*n+t[13],e[14]=l*i+u*r+g*n+t[14],e[15]=h*i+p*r+E*n+t[15]),e}function Ge(e,t,s){var i=s[0],r=s[1],n=s[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Xe(e,t,s){var i=Math.sin(s),r=Math.cos(s),n=t[4],a=t[5],o=t[6],l=t[7],h=t[8],c=t[9],d=t[10],u=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*r+h*i,e[5]=a*r+c*i,e[6]=o*r+d*i,e[7]=l*r+u*i,e[8]=h*r-n*i,e[9]=c*r-a*i,e[10]=d*r-o*i,e[11]=u*r-l*i,e}function He(e,t,s){var i=Math.sin(s),r=Math.cos(s),n=t[0],a=t[1],o=t[2],l=t[3],h=t[8],c=t[9],d=t[10],u=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*r-h*i,e[1]=a*r-c*i,e[2]=o*r-d*i,e[3]=l*r-u*i,e[8]=n*i+h*r,e[9]=a*i+c*r,e[10]=o*i+d*r,e[11]=l*i+u*r,e}function We(e,t,s){var i=Math.sin(s),r=Math.cos(s),n=t[0],a=t[1],o=t[2],l=t[3],h=t[4],c=t[5],d=t[6],u=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*r+h*i,e[1]=a*r+c*i,e[2]=o*r+d*i,e[3]=l*r+u*i,e[4]=h*r-n*i,e[5]=c*r-a*i,e[6]=d*r-o*i,e[7]=u*r-l*i,e}function ze(){var e=new De(3);return De!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function $e(e,t,s){var i=new De(3);return i[0]=e,i[1]=t,i[2]=s,i}function Ye(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}var je,Ke,qe,Ze,Qe=function(e,t){var s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2];return Math.sqrt(s*s+i*i+r*r)};function Je(){var e=new De(2);return De!=Float32Array&&(e[0]=0,e[1]=0),e}ze(),function(){var e=Je()}();class et{constructor(){this.click=!1,this.leftClick=!1,this.rightClick=!1,this.position=Je(),this.delta=Je()}}class tt{constructor(){this.pressed=!1,this.position=Je(),this.delta=Je()}}class st{constructor(e){this.projectionMatrix=Oe(),this.fov=Fe(100),this.near=1,this.far=8192,this.viewMatrix=Oe(),this.position=ze(),this.rotation=ze(),this.aspect=e,this.updateProjectionMatrix()}static init(e){return new st(e)}updateProjectionMatrix(){var e,t,s,i,r,n,a;e=this.projectionMatrix,t=this.fov,s=this.aspect,i=this.near,r=this.far,n=1/Math.tan(t/2),a=void 0,e[0]=n/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(a=1/(i-r),e[10]=(r+i)*a,e[14]=2*r*i*a):(e[10]=-1,e[14]=-2*i)}updateViewMatrix(){Be(this.viewMatrix),Xe(this.viewMatrix,this.viewMatrix,this.rotation[0]-Math.PI/2),We(this.viewMatrix,this.viewMatrix,Math.PI/2-this.rotation[1]),Ve(this.viewMatrix,this.viewMatrix,[-this.position[0],-this.position[1],-this.position[2]])}}class it{constructor(){this.keys=new Uint8Array(256);for(let e=0;e<256;++e)this.keys[0]=0}}je=it||(it={}),(Ke=je.KEYS||(je.KEYS={}))[Ke.A="A".charCodeAt(0)]="A",Ke[Ke.B="B".charCodeAt(0)]="B",Ke[Ke.C="C".charCodeAt(0)]="C",Ke[Ke.D="D".charCodeAt(0)]="D",Ke[Ke.E="E".charCodeAt(0)]="E",Ke[Ke.F="F".charCodeAt(0)]="F",Ke[Ke.G="G".charCodeAt(0)]="G",Ke[Ke.H="H".charCodeAt(0)]="H",Ke[Ke.I="I".charCodeAt(0)]="I",Ke[Ke.J="J".charCodeAt(0)]="J",Ke[Ke.K="K".charCodeAt(0)]="K",Ke[Ke.L="L".charCodeAt(0)]="L",Ke[Ke.M="M".charCodeAt(0)]="M",Ke[Ke.N="N".charCodeAt(0)]="N",Ke[Ke.O="O".charCodeAt(0)]="O",Ke[Ke.P="P".charCodeAt(0)]="P",Ke[Ke.Q="Q".charCodeAt(0)]="Q",Ke[Ke.R="R".charCodeAt(0)]="R",Ke[Ke.S="S".charCodeAt(0)]="S",Ke[Ke.T="T".charCodeAt(0)]="T",Ke[Ke.U="U".charCodeAt(0)]="U",Ke[Ke.V="V".charCodeAt(0)]="V",Ke[Ke.W="W".charCodeAt(0)]="W",Ke[Ke.X="X".charCodeAt(0)]="X",Ke[Ke.Y="Y".charCodeAt(0)]="Y",Ke[Ke.Z="Z".charCodeAt(0)]="Z",Ke[Ke.CTRL=17]="CTRL",Ke[Ke.ALT=18]="ALT",Ke[Ke.SPACE=32]="SPACE",(Ze=qe||(qe={}))[Ze.VERTEX=0]="VERTEX",Ze[Ze.FRAGMENT=1]="FRAGMENT";class rt{static init(e){const t=e.getContext("webgl",{alpha:!1});return t?new rt(t):(console.error("Failed to get WebGL context"),null)}static checkWebGLSupport(){const e="Your browser does not seem to support WebGL",t="Your graphics card does not seem to support WebGL";if(!window.WebGLRenderingContext)return{hasSupport:!1,message:e};const s=document.createElement("canvas");try{return s.getContext("webgl")||s.getContext("experimental-webgl")?{hasSupport:!0,message:""}:{hasSupport:!1,message:t}}catch(e){return{hasSupport:!1,message:t}}}constructor(e){this.gl=e}createProgram(e){const t=this.gl;var s=t.createProgram();if(!s)return console.error("Failed to create WebGL program"),null;const i=this.createShader({source:e.vertexShaderSrc,type:0});if(!i)return console.error("Failed to compile vertex shader"),null;const r=this.createShader({source:e.fragmentShaderSrc,type:1});if(!r)return console.error("Failed to compile fragment shader"),null;if(t.attachShader(s,i),t.attachShader(s,r),t.linkProgram(s),t.validateProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){t.deleteProgram(s),t.deleteShader(i),t.deleteShader(r);const e=t.getProgramInfoLog(s);return console.error(`Could not initialize shader: ${e}`),null}if(!t.getProgramParameter(s,t.VALIDATE_STATUS)){t.deleteProgram(s),t.deleteShader(i),t.deleteShader(r);const e=t.getProgramInfoLog(s);return console.error(`Could not initialize shader: ${e}`),null}t.useProgram(s);const n={};for(let i=0;i<e.attributeNames.length;++i){const r=e.attributeNames[i],a=t.getAttribLocation(s,r);if(-1===a)return console.error(`gl.getAttribLocation failed for attrib named "${r}"`),t.deleteProgram(s),null;n[r]=a}const a={};for(let i=0;i<e.uniformNames.length;++i){const r=e.uniformNames[i],n=t.getUniformLocation(s,r);if(null===n)return console.error(`gl.getUniformLocation failed for uniform named "${r}"`),t.deleteProgram(s),null;a[r]=n}return{handle:s,attributes:n,uniforms:a}}createShader(e){const t=this.gl,s=0===e.type?t.createShader(t.VERTEX_SHADER):t.createShader(t.FRAGMENT_SHADER);return s?(t.shaderSource(s,e.source),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)?s:(console.error(t.getShaderInfoLog(s)),t.deleteShader(s),null)):(console.error("Failed to create shader program"),null)}getAnisotropyExtension(){return this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")}getMaxAnisotropy(e){return this.gl.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}}const nt=(e,t)=>{e.camera.position[0]=t.cameraPos[0],e.camera.position[1]=t.cameraPos[1],e.camera.position[2]=t.cameraPos[2],e.camera.rotation[0]=Fe(t.cameraRot[0]),e.camera.rotation[1]=Fe(t.cameraRot[1]),e.camera.rotation[2]=Fe(t.cameraRot[2])};class at extends EventTarget{constructor(e){super(),this.currentMap=0,this.currentChunk=0,this.currentTime=0,this.currentTick=0,this.isPlaying=!1,this.isPaused=!1,this.speed=1,this.reset(),this.game=e,this.state=new K,this.replay=null}reset(){if(this.currentMap=0,this.currentChunk=0,this.currentTime=0,this.currentTick=0,this.isPlaying=!1,this.isPaused=!1,this.speed=1,this.replay){let e=this.replay.maps[0].chunks[0];e.reader.seek(0),this.state=e.state.clone()}}on(e,t){return this.addEventListener(e,t)}off(e,t){this.removeEventListener(e,t)}changeReplay(e){this.replay=e,this.reset()}play(){this.isPlaying?this.isPaused&&(this.isPaused=!1):this.isPlaying=!0,this.dispatchEvent(R("play"))}pause(){this.isPlaying&&(this.isPaused=!0),this.dispatchEvent(R("pause"))}stop(){this.reset(),this.dispatchEvent(R("stop"))}speedUp(){this.speed=Math.min(2*this.speed,4)}speedDown(){this.speed=Math.max(this.speed/2,.25)}seek(e){let t=Math.max(0,Math.min(this.replay.length,e)),s=this.replay.maps;for(let e=0;e<s.length;++e){let i=s[e].chunks;for(let s=0;s<i.length;++s){let r=i[s],n=r.startTime,a=n+r.timeLength;if(t>=n&&t<a){this.currentMap=e,this.currentChunk=s,this.currentTime=t,this.state=r.state.clone();let i=this.replay.deltaDecoders,n=this.replay.customMessages,a=r.reader;for(a.seek(0);;){let e=a.tell(),s=ue.readFrame(a,i,n);if(!(s.time<=t)){a.seek(e);break}this.state.feedFrame(s),this.currentTick=s.tick}return void nt(this.game,this.state)}}}}seekByPercent(e){e=Math.max(0,Math.min(e,100))/100,e*=this.replay.length,this.seek(e)}update(e){if(!this.isPlaying||this.isPaused)return;let t=this.replay.deltaDecoders,s=this.replay.customMessages,i=this.replay.maps[this.currentMap],r=i.chunks[this.currentChunk],n=r.reader,a=this.currentTime+e*this.speed,o=!1;for(;;){let e=n.tell();if(e>=r.data.length){if(this.currentChunk===i.chunks.length-1){if(this.currentMap===this.replay.maps.length-1){o=!0;break}this.currentChunk=0,this.currentMap++,i=this.replay.maps[this.currentMap],r=i.chunks[this.currentChunk]}else this.currentChunk++,r=i.chunks[this.currentChunk];n=r.reader,n.seek(0),e=0;continue}let l=this.game.sounds,h=ue.readFrame(n,t,s);if(h.type<2)for(let e=0;e<h.data.length;++e){let t=h.data[e];if(6===t.type){let e=t.data,s=l.find((t=>t.index===e.soundIndex));if(s&&"common/null.wav"!==s.name){let t=e.channel,i=e.volume;this.game.soundSystem.play(s,t,i)}}else if(29===t.type){let e=t.data,s=l.find((t=>t.index===e.soundIndex));s&&s.name}else 9===t.type&&t.data.commands.forEach((e=>{switch(e.func){case"speak":case"spk":case"play":{let t=e.params[0]+".wav",s=l.find((e=>e.name===t));if(!s)return;this.game.soundSystem.play(s,1,.7);break}case"playvol":{let t,s=e.params[0]+".wav";t=isNaN(e.params[1])?1:parseFloat(e.params[1]);let i=l.find((e=>e.name===s));if(!i)return;this.game.soundSystem.play(i,1,t);break}}}))}else if(8===h.type){let e=h.sound.sample,t=l.find((t=>t.name===e));if(t&&"common/null.wav"!==t.name){let e=h.sound.channel,s=h.sound.volume;this.game.soundSystem.play(t,e,s)}}if(!(h.time<=a)){n.seek(e);break}this.state.feedFrame(h),this.currentTick=h.tick}nt(this.game,this.state),this.currentTime=a,o&&this.stop()}}class ot{constructor(e){this.draw=()=>{const e=this.context.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},this.context=e.context}static init(e){const t=e.gl;return t.clearColor(0,0,0,1),t.clearDepth(1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.enable(t.CULL_FACE),t.cullFace(t.FRONT),new ot({context:e})}}class lt{static init(e){const t=e.createProgram({vertexShaderSrc:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nattribute vec3 position;\nattribute vec2 texCoord;\n\nvarying vec2 vTexCoord;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nvoid main(void) {\n  vTexCoord = texCoord;\n  gl_Position = projectionMatrix * viewMatrix * vec4(position, 1);\n}",fragmentShaderSrc:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform sampler2D diffuse;\n\nvarying vec2 vTexCoord;\n\nvoid main(void) {\n  vec4 diffuseColor = texture2D(diffuse, vTexCoord);\n  gl_FragColor = vec4(diffuseColor.rgb, 1.0);\n}",attributeNames:["position","texCoord"],uniformNames:["viewMatrix","projectionMatrix","diffuse"]});return t?new lt(t):(console.error("Failed to create sky shader program"),null)}constructor(e){this.program=e.handle,this.aPosition=e.attributes.position,this.aTexCoord=e.attributes.texCoord,this.uViewMx=e.uniforms.viewMatrix,this.uProjectionMx=e.uniforms.projectionMatrix,this.uDiffuse=e.uniforms.diffuse}useProgram(e){e.useProgram(this.program)}setViewMatrix(e,t){e.uniformMatrix4fv(this.uViewMx,!1,t)}setProjectionMatrix(e,t){e.uniformMatrix4fv(this.uProjectionMx,!1,t)}setDiffuse(e,t){e.uniform1i(this.uDiffuse,t)}enableVertexAttribs(e){e.enableVertexAttribArray(this.aPosition),e.enableVertexAttribArray(this.aTexCoord)}setVertexAttribPointers(e){e.vertexAttribPointer(this.aPosition,3,e.FLOAT,!1,20,0),e.vertexAttribPointer(this.aTexCoord,2,e.FLOAT,!1,20,12)}}class ht{constructor(e){this.vertexBuffer=null,this.indexBuffer=null,this.texture=null,this.isReady=!1,this.context=e.context,this.shader=e.shader}static init(e){const t=lt.init(e);return t?new ht({context:e,shader:t}):(console.error("skyscenen't"),null)}changeMap(e){if(6!==e.skies.length)return void(this.isReady=!1);const t=this.context.gl,s=t.createBuffer(),i=t.createBuffer(),r=t.createTexture();if(!s||!i||!r)throw new Error("shouldnt happen");const n=new Uint8Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),a=new Float32Array([-1,-1,1,.499,.001,1,-1,1,.499,.249,1,1,1,.001,.249,-1,1,1,.001,.001,-1,-1,-1,.499,.749,-1,1,-1,.001,.749,1,1,-1,.001,.501,1,-1,-1,.499,.501,-1,1,-1,.501,.749,-1,1,1,.501,.501,1,1,1,.999,.501,1,1,-1,.999,.749,-1,-1,-1,.999,.249,1,-1,-1,.501,.249,1,-1,1,.501,.001,-1,-1,1,.999,.001,1,-1,-1,.499,.499,1,1,-1,.001,.499,1,1,1,.001,.251,1,-1,1,.499,.251,-1,-1,-1,.501,.499,-1,-1,1,.501,.251,-1,1,1,.999,.251,-1,1,-1,.999,.499].map(((e,t)=>t%5<3?4096*e:e)));t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW);const o=document.createElement("canvas");o.width=512,o.height=1024;const l=o.getContext("2d");if(!l)throw new Error("sky ctx fail");const h={up:[0,0],rt:[0,256],dn:[0,512],ft:[256,0],lf:[256,256],bk:[256,512]};e.skies.forEach((e=>{const t=document.createElement("canvas"),s=t.getContext("2d");if(!s)throw new Error("Runtime error.");t.width=e.width,t.height=e.height;const i=s.getImageData(0,0,t.width,t.height);for(let t=0;t<e.data.length;++t)i.data[t]=e.data[t];s.putImageData(i,0,0);const r=e.name.slice(-2),n=h[r]?h[r]:[];if(!l)throw new Error("Runtime error.");l.drawImage(t,n[0],n[1])}));const c=l.getImageData(0,0,512,1024).data;t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,512,1024,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array(c)),t.generateMipmap(t.TEXTURE_2D),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);const d=this.context.getAnisotropyExtension();d&&t.texParameteri(t.TEXTURE_2D,d.TEXTURE_MAX_ANISOTROPY_EXT,this.context.getMaxAnisotropy(d)),this.vertexBuffer=s,this.indexBuffer=i,this.texture=r,this.isReady=!0}draw(e){if(!this.isReady)return;const t=this.context.gl,s=this.shader;s.useProgram(t),t.bindTexture(t.TEXTURE_2D,this.texture),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),s.enableVertexAttribs(t),s.setVertexAttribPointers(t),s.setDiffuse(t,0);const i=e.position[0],r=e.position[1],n=e.position[2];e.position[0]=0,e.position[1]=0,e.position[2]=0,e.updateViewMatrix(),e.position[0]=i,e.position[1]=r,e.position[2]=n,s.setViewMatrix(t,e.viewMatrix),s.setProjectionMatrix(t,e.projectionMatrix),t.drawElements(t.TRIANGLES,36,t.UNSIGNED_BYTE,0),t.clear(t.DEPTH_BUFFER_BIT)}}class ct{static init(e){const t=e.createProgram({vertexShaderSrc:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nattribute vec3 position;\nattribute vec2 texCoord;\nattribute vec2 texCoord2;\n\nvarying vec2 vTexCoord;\nvarying vec2 vLightmapCoord;\n\nuniform mat4 modelMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nvoid main(void) {\n  vTexCoord = texCoord;\n  vLightmapCoord = texCoord2;\n\n  gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1);\n}",fragmentShaderSrc:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform sampler2D diffuse;\nuniform sampler2D lightmap;\nuniform float opacity;\n\nvarying vec2 vTexCoord;\nvarying vec2 vLightmapCoord;\n\nvoid main(void) {\n  vec4 diffuseColor = texture2D(diffuse, vTexCoord);\n  vec4 lightColor = texture2D(lightmap, vLightmapCoord);\n\n  gl_FragColor = vec4(diffuseColor.rgb * lightColor.rgb, diffuseColor.a * opacity);\n}",attributeNames:["position","texCoord","texCoord2"],uniformNames:["modelMatrix","viewMatrix","projectionMatrix","diffuse","lightmap","opacity"]});return t?new ct(t):(console.error("Failed to create MainShader program"),null)}constructor(e){this.program=e.handle,this.aPosition=e.attributes.position,this.aTexCoord=e.attributes.texCoord,this.aTexCoord2=e.attributes.texCoord2,this.uModelMx=e.uniforms.modelMatrix,this.uViewMx=e.uniforms.viewMatrix,this.uProjectionMx=e.uniforms.projectionMatrix,this.uDiffuse=e.uniforms.diffuse,this.uLightmap=e.uniforms.lightmap,this.uOpacity=e.uniforms.opacity}useProgram(e){e.useProgram(this.program)}setModelMatrix(e,t){e.uniformMatrix4fv(this.uModelMx,!1,t)}setViewMatrix(e,t){e.uniformMatrix4fv(this.uViewMx,!1,t)}setProjectionMatrix(e,t){e.uniformMatrix4fv(this.uProjectionMx,!1,t)}setDiffuse(e,t){e.uniform1i(this.uDiffuse,t)}setLightmap(e,t){e.uniform1i(this.uLightmap,t)}setOpacity(e,t){e.uniform1f(this.uOpacity,t)}enableVertexAttribs(e){e.enableVertexAttribArray(this.aPosition),e.enableVertexAttribArray(this.aTexCoord),e.enableVertexAttribArray(this.aTexCoord2)}setVertexAttribPointers(e){e.vertexAttribPointer(this.aPosition,3,e.FLOAT,!1,28,0),e.vertexAttribPointer(this.aTexCoord,2,e.FLOAT,!1,28,12),e.vertexAttribPointer(this.aTexCoord2,2,e.FLOAT,!1,28,20)}}var dt,ut,pt,ft,mt,gt,Et,xt,yt,bt,_t,wt,Tt,kt,vt,St,At,It,Mt,Rt,Lt,Ct,Pt,Nt,Dt,Ut,Ft,Ot,Bt,Vt;(ut=dt||(dt={}))[ut.No=0]="No",ut[ut.Yes=1]="Yes",(ft=pt||(pt={}))[ft.No=0]="No",ft[ft.Yes=1]="Yes",(gt=mt||(mt={}))[gt.No=0]="No",gt[gt.Yes=1]="Yes",(xt=Et||(Et={}))[xt.FewestPlayers=0]="FewestPlayers",xt[xt.FirstTeam=1]="FirstTeam",(bt=yt||(yt={}))[bt.No=0]="No",bt[bt.Walk=1]="Walk",bt[bt.Run=2]="Run",bt[bt.Instantaneous=4]="Instantaneous",bt[bt.No_TurnToFace=5]="No_TurnToFace",(wt=_t||(_t={}))[wt.DefaultAI=0]="DefaultAI",wt[wt.Ambush=1]="Ambush",(kt=Tt||(Tt={}))[kt.Repeatable=4]="Repeatable",kt[kt.LeaveCorpse=8]="LeaveCorpse",(St=vt||(vt={}))[St.None=0]="None",St[St.HugeMachine=1]="HugeMachine",St[St.BigMachine=2]="BigMachine",St[St.Machine=3]="Machine",St[St.SlowFadeIn=4]="SlowFadeIn",St[St.FadeIn=5]="FadeIn",St[St.QuickFadeIn=6]="QuickFadeIn",St[St.SlowPulse=7]="SlowPulse",St[St.Pulse=8]="Pulse",St[St.QuickPulse=9]="QuickPulse",St[St.SlowOscillator=10]="SlowOscillator",St[St.Oscillator=11]="Oscillator",St[St.QuickOscillator=12]="QuickOscillator",St[St.GrungePitch=13]="GrungePitch",St[St.VeryLowPitch=14]="VeryLowPitch",St[St.LowPitch=15]="LowPitch",St[St.HighPitch=16]="HighPitch",St[St.VeryHighPitch=17]="VeryHighPitch",St[St.ScreamingPitch=18]="ScreamingPitch",St[St.OscillateSpinUpDown=19]="OscillateSpinUpDown",St[St.PulseSpinUpDown=20]="PulseSpinUpDown",St[St.RandomPitch=21]="RandomPitch",St[St.RandomPitchFast=22]="RandomPitchFast",St[St.IncrementalSpinup=23]="IncrementalSpinup",St[St.Alien=24]="Alien",St[St.Bizzare=25]="Bizzare",St[St.PlanetX=26]="PlanetX",St[St.Haunted=27]="Haunted",(It=At||(At={}))[It.PlayEverywhere=1]="PlayEverywhere",It[It.SmallRadius=2]="SmallRadius",It[It.MediumRadius=4]="MediumRadius",It[It.LargeRadius=8]="LargeRadius",It[It.StartSilent=16]="StartSilent",It[It.NotToggled=32]="NotToggled",(Rt=Mt||(Mt={}))[Rt.UseActivates=1]="UseActivates",Rt[Rt.StartOn=2]="StartOn",(Ct=Lt||(Lt={}))[Ct.NoTrigger=0]="NoTrigger",Ct[Ct.SeePlayerMadAtPlayer=1]="SeePlayerMadAtPlayer",Ct[Ct.TakeDamage=2]="TakeDamage",Ct[Ct.HalfHealthRemaining=3]="HalfHealthRemaining",Ct[Ct.Death=4]="Death",Ct[Ct.HearWorld=7]="HearWorld",Ct[Ct.HearPlayer=8]="HearPlayer",Ct[Ct.HearCombat=9]="HearCombat",Ct[Ct.SeePlayerUnconditional=10]="SeePlayerUnconditional",Ct[Ct.SeePlayerNotInCombat=11]="SeePlayerNotInCombat",(Nt=Pt||(Pt={}))[Nt.StartOn=1]="StartOn",Nt[Nt.Toggle=2]="Toggle",Nt[Nt.RandomStrike=4]="RandomStrike",Nt[Nt.Ring=8]="Ring",Nt[Nt.StartSparks=16]="StartSparks",Nt[Nt.EndSparks=32]="EndSparks",Nt[Nt.DecalEnd=64]="DecalEnd",Nt[Nt.FadeStart=128]="FadeStart",Nt[Nt.FadeEnd=256]="FadeEnd",(Ut=Dt||(Dt={}))[Ut.Normal=0]="Normal",Ut[Ut.EmbeddedFix=1]="EmbeddedFix",Ut[Ut.OpaqueBlockLight=2]="OpaqueBlockLight",Ut[Ut.OpaqueEmbeddedFix=3]="OpaqueEmbeddedFix",Ut[Ut.OpaqueConcaveFix=6]="OpaqueConcaveFix",(Ot=Ft||(Ft={}))[Ot.Normal=0]="Normal",Ot[Ot.SlowPulse=1]="SlowPulse",Ot[Ot.FastPulse=2]="FastPulse",Ot[Ot.SlowWidePulse=3]="SlowWidePulse",Ot[Ot.FastWidePulse=4]="FastWidePulse",Ot[Ot.SlowFadeAway=5]="SlowFadeAway",Ot[Ot.FastFadeAway=6]="FastFadeAway",Ot[Ot.SlowBecomeSolid=7]="SlowBecomeSolid",Ot[Ot.FastBecomeSolid=8]="FastBecomeSolid",Ot[Ot.SlowStrobe=9]="SlowStrobe",Ot[Ot.FastStrobe=10]="FastStrobe",Ot[Ot.FasterStrobe=11]="FasterStrobe",Ot[Ot.SlowFlicker=12]="SlowFlicker",Ot[Ot.FastFlicker=13]="FastFlicker",Ot[Ot.ConstantGlow=14]="ConstantGlow",Ot[Ot.DistortModels=15]="DistortModels",Ot[Ot.HologramDistort=16]="HologramDistort",(Vt=Bt||(Bt={}))[Vt.Normal=0]="Normal",Vt[Vt.Color=1]="Color",Vt[Vt.Texture=2]="Texture",Vt[Vt.Glow=3]="Glow",Vt[Vt.Solid=4]="Solid",Vt[Vt.Additive=5]="Additive";const Gt=(e,t,s,i,r)=>{const n=document.createElement("canvas"),a=n.getContext("2d");if(!a)throw new Error("Runtime error.");n.width=t,n.height=s;const o=document.createElement("canvas"),l=o.getContext("2d");if(!l)throw new Error("Runtime error.");o.width=i,o.height=r;const h=a.createImageData(t,s);for(let i=0,r=t*s*4;i<r;i+=4)h.data[i]=e[i],h.data[i+1]=e[i+1],h.data[i+2]=e[i+2],h.data[i+3]=e[i+3];return a.putImageData(h,0,0),l.drawImage(n,0,0,i,r),new Uint8Array(l.getImageData(0,0,i,r).data)},Xt=e=>0==(e&e-1),Ht=e=>{--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1};class Wt{constructor(e){this.modelMatrix=Oe(),this.sceneInfo={length:0,data:new Float32Array(0),models:[]},this.bsp=null,this.textures=[],this.sprites={},this.lightmap=null,this.buffer=e.buffer,this.context=e.context,this.shader=e.shader}static init(e){const t=ct.init(e);if(!t)return console.error("Failed to init MainShader"),null;t.useProgram(e.gl);const s=e.gl.createBuffer();return s?new Wt({buffer:s,context:e,shader:t}):(console.error("Failed to create WebGL buffer"),null)}changeMap(e){this.fillBuffer(e),this.loadTextures(e),this.loadSpriteTextures(e),this.loadLightmap(e),this.bsp=e}fillBuffer(e){const t=this.context.gl,s=e.models,i=["aaatrigger","clip","null","hint","nodraw","invisible","skip","trigger","sky","fog"];let r=0;for(let t=0;t<s.length;++t){const n=s[t];for(let t=0;t<n.faces.length;++t){const s=e.textures[n.faces[t].textureIndex];i.indexOf(s.name)>-1||(r+=n.faces[t].buffer.length)}}r+=42;const n={length:r,data:new Float32Array(r),models:[]};let a=0;for(let t=0;t<e.models.length;++t){const s=e.models[t],r={origin:s.origin,offset:a,length:0,isTransparent:!1,faces:[]};for(let t=0;t<s.faces.length;++t){const o=e.textures[s.faces[t].textureIndex];if(i.indexOf(o.name)>-1)continue;const l={offset:a,length:0,textureIndex:-1};for(let e=0;e<s.faces[t].buffer.length;++e)n.data[a++]=s.faces[t].buffer[e];r.isTransparent||"{"!==e.textures[s.faces[t].textureIndex].name[0]||(r.isTransparent=!0),l.textureIndex=s.faces[t].textureIndex,l.length=a-l.offset,r.faces.push(l)}r.length=a-r.offset,n.models.push(r)}n.models.push({origin:[0,0,0],offset:a,length:4,isTransparent:!1,faces:[{offset:a,length:4,textureIndex:0}]}),n.data[a++]=-.5,n.data[a++]=0,n.data[a++]=-.5,n.data[a++]=1,n.data[a++]=1,n.data[a++]=0,n.data[a++]=0,n.data[a++]=.5,n.data[a++]=0,n.data[a++]=.5,n.data[a++]=0,n.data[a++]=0,n.data[a++]=0,n.data[a++]=0,n.data[a++]=-.5,n.data[a++]=0,n.data[a++]=.5,n.data[a++]=1,n.data[a++]=0,n.data[a++]=0,n.data[a++]=0,n.data[a++]=-.5,n.data[a++]=0,n.data[a++]=-.5,n.data[a++]=1,n.data[a++]=1,n.data[a++]=0,n.data[a++]=0,n.data[a++]=.5,n.data[a++]=0,n.data[a++]=-.5,n.data[a++]=0,n.data[a++]=1,n.data[a++]=0,n.data[a++]=0,n.data[a++]=.5,n.data[a++]=0,n.data[a++]=.5,n.data[a++]=0,n.data[a++]=0,n.data[a++]=0,n.data[a++]=0,a=0;const o={data:new Float32Array(n.data),length:n.length,models:n.models.map((e=>({origin:[...e.origin],offset:e.offset,length:e.length,isTransparent:e.isTransparent,faces:e.faces.map((e=>({offset:e.offset,length:e.length,textureIndex:e.textureIndex})))})))};for(let e=0;e<o.models.length;++e){const t=o.models[e];t.faces.sort(((e,t)=>e.textureIndex-t.textureIndex));for(let e=0;e<t.faces.length;++e){const s=t.faces[e],i=a;for(let e=0;e<s.length;++e)o.data[a]=n.data[s.offset+e],a+=1;s.offset=i}const s=[];let i=-1;for(let e=0;e<t.faces.length;++e){const r=t.faces[e];r.textureIndex===i?s[s.length-1].length+=r.length:(s.push({offset:r.offset,length:r.length,textureIndex:r.textureIndex}),i=r.textureIndex)}t.faces=s}this.sceneInfo=o,t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.sceneInfo.data,t.STATIC_DRAW)}loadTextures(e){const t=this.context.gl;for(let s=0;s<e.textures.length;++s){const i=t.createTexture();if(!i)throw new Error("fatal error");const r=e.textures[s];if(!Xt(r.width)||!Xt(r.height)){const e=r.width,t=r.height,s=Ht(r.width),i=Ht(r.height);r.data=Gt(r.data,e,t,s,i),r.width=s,r.height=i}t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r.width,r.height,0,t.RGBA,t.UNSIGNED_BYTE,r.data),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.generateMipmap(t.TEXTURE_2D);const n=this.context.getAnisotropyExtension();n&&t.texParameteri(t.TEXTURE_2D,n.TEXTURE_MAX_ANISOTROPY_EXT,this.context.getMaxAnisotropy(n)),this.textures.push({name:r.name,width:r.width,height:r.height,data:r.data,handle:i})}}loadSpriteTextures(e){const t=this.context.gl;for(const[s,i]of Object.entries(e.sprites)){const e=t.createTexture();if(!e)throw new Error("fatal error");const r=i.frames[0];if(!Xt(r.width)||!Xt(r.height)){const e=r.width,t=r.height,s=Ht(r.width),i=Ht(r.height);r.data=Gt(r.data,e,t,s,i),r.width=s,r.height=i}t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r.width,r.height,0,t.RGBA,t.UNSIGNED_BYTE,r.data),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.generateMipmap(t.TEXTURE_2D);const n=this.context.getAnisotropyExtension();n&&t.texParameteri(t.TEXTURE_2D,n.TEXTURE_MAX_ANISOTROPY_EXT,this.context.getMaxAnisotropy(n)),this.textures.push({name:s,width:r.width,height:r.height,data:r.data,handle:e}),this.sprites[s]=i}}loadLightmap(e){const t=this.context.gl,s=t.createTexture();if(!s)throw new Error("fatal error");t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.lightmap.width,e.lightmap.height,0,t.RGBA,t.UNSIGNED_BYTE,e.lightmap.data),t.generateMipmap(t.TEXTURE_2D),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),this.lightmap={data:e.lightmap.data,handle:s}}draw(e,t){if(!this.bsp||!this.lightmap)return;const s=this.context.gl,i=this.shader;i.useProgram(s),e.updateProjectionMatrix(),e.updateViewMatrix(),i.setViewMatrix(s,e.viewMatrix),i.setProjectionMatrix(s,e.projectionMatrix),s.bindBuffer(s.ARRAY_BUFFER,this.buffer),i.enableVertexAttribs(s),i.setVertexAttribPointers(s),i.setDiffuse(s,0),i.setLightmap(s,1),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,this.lightmap.handle),s.activeTexture(s.TEXTURE0);const r=[],n=[];for(let e=1;e<t.length;++e){const s=t[e];if(s.model)if(s.rendermode&&s.rendermode!=Bt.Normal&&s.rendermode!=Bt.Solid)s.rendermode,Bt.Additive,n.push(s);else{if("*"===s.model[0]){if(this.sceneInfo.models[parseInt(s.model.substr(1))].isTransparent){n.push(s);continue}}else if(s.model.indexOf(".spr")>-1){n.push(s);continue}r.push(s)}}i.setOpacity(s,1),this.renderWorldSpawn(),this.renderOpaqueEntities(e,r),n.length&&(s.depthMask(!1),this.renderTransparentEntities(n,e),s.depthMask(!0))}renderWorldSpawn(){const e=this.sceneInfo.models[0],t=this.context.gl;Be(this.modelMatrix),this.shader.setModelMatrix(t,this.modelMatrix);for(let s=0;s<e.faces.length;++s){const i=e.faces[s];t.bindTexture(t.TEXTURE_2D,this.textures[i.textureIndex].handle),t.drawArrays(t.TRIANGLES,i.offset/7,i.length/7)}}renderOpaqueEntities(e,t){const s=this.context.gl,i=this.shader,r=this.modelMatrix;for(let l=0;l<t.length;++l){const h=t[l],c=parseInt(h.model.substr(1)),d=this.sceneInfo.models[c];if(d){const e=h.angles||[0,0,0],t=h.origin?$e(h.origin[0],h.origin[1],h.origin[2]):ze();n=t,a=t,o=d.origin,n[0]=a[0]+o[0],n[1]=a[1]+o[1],n[2]=a[2]+o[2],Be(r),Ve(r,r,t),We(r,r,e[1]*Math.PI/180),Xe(this.modelMatrix,this.modelMatrix,e[2]*Math.PI/180),i.setModelMatrix(s,this.modelMatrix);for(let e=0;e<d.faces.length;++e){const t=d.faces[e];s.bindTexture(s.TEXTURE_2D,this.textures[t.textureIndex].handle),s.drawArrays(s.TRIANGLES,t.offset/7,t.length/7)}}else if(h.model.indexOf(".spr")>-1){const t=this.textures.find((e=>e.name===h.model)),n=this.sprites[h.model];if(t&&n){const a=h.origin?$e(h.origin[0],h.origin[1],h.origin[2]):ze(),o=$e(t.width,1,t.height),l=h.angles?$e(h.angles[0],h.angles[2],h.angles[1]):ze();switch(Ye(o,o,h.scale||1),Be(r),Ve(r,r,a),n.header.type){case pe.VP_PARALLEL_UPRIGHT:case pe.FACING_UPRIGHT:We(r,r,e.rotation[1]+Math.PI/2);break;case pe.VP_PARALLEL:We(r,r,Math.atan2(a[1]-e.position[1],a[0]-e.position[0])+Math.PI/2),Xe(r,r,Math.atan2(e.position[2]-a[2],Math.sqrt(Math.pow(e.position[0]-a[0],2)+Math.pow(e.position[1]-a[1],2))));break;case pe.ORIENTED:He(r,r,l[0]*Math.PI/180+Math.PI),We(r,r,l[1]*Math.PI/180+Math.PI),Xe(r,r,l[2]*Math.PI/180-Math.PI/2);break;case pe.VP_PARALLEL_ORIENTED:He(r,r,l[0]*Math.PI/180+Math.PI),We(r,r,l[1]*Math.PI/180+Math.PI);break;default:throw new Error("Invalid sprite type")}Ge(r,r,o),i.setModelMatrix(s,r),i.setOpacity(s,(h.renderamt||255)/255);switch(h.rendermode||Bt.Normal){case Bt.Normal:i.setOpacity(s,1),s.bindTexture(s.TEXTURE_2D,t.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6);break;case Bt.Color:case Bt.Texture:i.setOpacity(s,(h.renderamt||255)/255),s.bindTexture(s.TEXTURE_2D,t.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6);break;case Bt.Glow:s.blendFunc(s.SRC_ALPHA,s.DST_ALPHA),i.setOpacity(s,(h.renderamt||255)/255),s.bindTexture(s.TEXTURE_2D,t.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA);break;case Bt.Solid:i.setOpacity(s,(h.renderamt||255)/255),s.bindTexture(s.TEXTURE_2D,t.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6);break;case Bt.Additive:s.blendFunc(s.SRC_ALPHA,s.DST_ALPHA),i.setOpacity(s,(h.renderamt||255)/255),s.bindTexture(s.TEXTURE_2D,t.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)}}}}var n,a,o}renderTransparentEntities(e,t){const s=this.context.gl,i=this.shader,r=this.modelMatrix,n=e.map(((e,s)=>({index:s,distance:Qe(t.position,e.origin||[0,0,0])}))).sort(((e,t)=>e.distance-t.distance));for(let a=0;a<n.length;++a){const o=e[n[a].index],l=parseInt(o.model.substr(1)),h=this.sceneInfo.models[l];if(h){const e=o.angles||[0,0,0],t=o.origin||[0,0,0];t[0]+=h.origin[0],t[1]+=h.origin[1],t[2]+=h.origin[2],Be(r),Ve(r,r,t),We(r,r,e[1]*Math.PI/180),Xe(this.modelMatrix,this.modelMatrix,e[2]*Math.PI/180),i.setModelMatrix(s,this.modelMatrix);switch(o.rendermode||Bt.Normal){case Bt.Normal:i.setOpacity(s,1);for(let e=0;e<h.faces.length;++e){const t=h.faces[e];s.bindTexture(s.TEXTURE_2D,this.textures[t.textureIndex].handle),s.drawArrays(s.TRIANGLES,t.offset/7,t.length/7)}break;case Bt.Color:i.setOpacity(s,(o.renderamt||255)/255);for(let e=0;e<h.faces.length;++e){const t=h.faces[e];s.bindTexture(s.TEXTURE_2D,this.textures[t.textureIndex].handle),s.drawArrays(s.TRIANGLES,t.offset/7,t.length/7)}break;case Bt.Texture:i.setOpacity(s,(o.renderamt||255)/255);for(let e=0;e<h.faces.length;++e){const t=h.faces[e];s.bindTexture(s.TEXTURE_2D,this.textures[t.textureIndex].handle),s.drawArrays(s.TRIANGLES,t.offset/7,t.length/7)}break;case Bt.Glow:i.setOpacity(s,(o.renderamt||255)/255);for(let e=0;e<h.faces.length;++e){const t=h.faces[e];s.bindTexture(s.TEXTURE_2D,this.textures[t.textureIndex].handle),s.drawArrays(s.TRIANGLES,t.offset/7,t.length/7)}break;case Bt.Solid:i.setOpacity(s,(o.renderamt||255)/255);for(let e=0;e<h.faces.length;++e){const t=h.faces[e];s.bindTexture(s.TEXTURE_2D,this.textures[t.textureIndex].handle),s.drawArrays(s.TRIANGLES,t.offset/7,t.length/7)}break;case Bt.Additive:s.blendFunc(s.SRC_ALPHA,s.DST_ALPHA),i.setOpacity(s,(o.renderamt||255)/255);for(let e=0;e<h.faces.length;++e){const t=h.faces[e];s.bindTexture(s.TEXTURE_2D,this.textures[t.textureIndex].handle),s.drawArrays(s.TRIANGLES,t.offset/7,t.length/7)}s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)}}else if(o.model.indexOf(".spr")>-1){const e=this.textures.find((e=>e.name===o.model)),n=this.sprites[o.model];if(e&&n){const a=o.origin?$e(o.origin[0],o.origin[1],o.origin[2]):ze(),l=$e(e.width,1,e.height),h=o.angles?$e(o.angles[0],o.angles[2],o.angles[1]):ze();switch(Ye(l,l,o.scale||1),Be(r),Ve(r,r,a),n.header.type){case pe.VP_PARALLEL_UPRIGHT:case pe.FACING_UPRIGHT:We(r,r,t.rotation[1]+Math.PI/2);break;case pe.VP_PARALLEL:We(r,r,Math.atan2(a[1]-t.position[1],a[0]-t.position[0])+Math.PI/2),Xe(r,r,Math.atan2(t.position[2]-a[2],Math.sqrt(Math.pow(t.position[0]-a[0],2)+Math.pow(t.position[1]-a[1],2))));break;case pe.ORIENTED:He(r,r,h[0]*Math.PI/180+Math.PI),We(r,r,h[1]*Math.PI/180+Math.PI),Xe(r,r,h[2]*Math.PI/180-Math.PI/2);break;case pe.VP_PARALLEL_ORIENTED:He(r,r,h[0]*Math.PI/180+Math.PI),We(r,r,h[1]*Math.PI/180+Math.PI);break;default:throw new Error("Invalid sprite type")}Ge(r,r,l),i.setModelMatrix(s,r),i.setOpacity(s,(o.renderamt||255)/255);switch(o.rendermode||Bt.Normal){case Bt.Normal:i.setOpacity(s,1),s.bindTexture(s.TEXTURE_2D,e.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6);break;case Bt.Color:case Bt.Texture:i.setOpacity(s,(o.renderamt||255)/255),s.bindTexture(s.TEXTURE_2D,e.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6);break;case Bt.Glow:s.blendFunc(s.SRC_ALPHA,s.DST_ALPHA),i.setOpacity(s,(o.renderamt||255)/255),s.bindTexture(s.TEXTURE_2D,e.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA);break;case Bt.Solid:i.setOpacity(s,(o.renderamt||255)/255),s.bindTexture(s.TEXTURE_2D,e.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6);break;case Bt.Additive:s.blendFunc(s.SRC_ALPHA,s.DST_ALPHA),i.setOpacity(s,(o.renderamt||255)/255),s.bindTexture(s.TEXTURE_2D,e.handle),s.drawArrays(s.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)}}}}}}var zt,$t;($t=zt||(zt={}))[$t.FREE=0]="FREE",$t[$t.REPLAY=1]="REPLAY";class Yt extends EventTarget{constructor(e){super(),this.pauseTime=0,this.isPaused=!1,this.lastTime=0,this.accumTime=0,this.timeStep=1/60,this.title="",this.pointerLocked=!1,this.touch=new tt,this.mouse=new et,this.keyboard=new it,this.entities=[],this.onLoadAll=e=>{if(e&&e.replay&&(this.changeReplay(e.replay.data),this.changeMode(1)),!e.map||!e.map.data)return;const t=e.map.data,s=e.skies;let i=!0;s.forEach((e=>{i=i&&e.isDone()})),i&&s.forEach((e=>e.data?t.skies.push(e.data):0)),Object.entries(e.sprites).forEach((([e,s])=>{s.data&&(t.sprites[e]=s.data)})),e.sounds.length>0&&e.sounds.forEach((e=>{e.data&&this.sounds.push(e.data)})),this.changeMap(t),this.dispatchEvent(R("load",{detail:{item:e}}))},this.draw=()=>{requestAnimationFrame(this.draw);const e=this.canvas,t=e.parentElement;if(t){const s=t.clientWidth,i=t.clientHeight;e.width===s&&e.height===i||(e.width=s,e.height=i,this.camera.aspect=e.clientWidth/e.clientHeight,this.camera.updateProjectionMatrix(),this.context.gl.viewport(0,0,this.context.gl.drawingBufferWidth,this.context.gl.drawingBufferHeight)),e.clientWidth===e.width&&e.clientHeight===e.height||(e.width=e.clientWidth,e.height=e.clientHeight,this.camera.aspect=e.clientWidth/e.clientHeight,this.camera.updateProjectionMatrix(),this.context.gl.viewport(0,0,this.context.gl.drawingBufferWidth,this.context.gl.drawingBufferHeight))}const s=P()/1e3,i=s-this.lastTime;for(this.accumTime+=i;this.accumTime>this.timeStep;)this.update(this.timeStep),this.accumTime-=this.timeStep;this.renderer.draw(),""!==this.mapName&&(this.skyScene.draw(this.camera),this.worldScene.draw(this.camera,this.entities)),this.lastTime=s},this.onTouchStart=e=>{const t=e.touches.item(0);t&&(this.touch.pressed=!0,this.touch.position[0]=t.clientX,this.touch.position[1]=t.clientY)},this.onTouchEnd=()=>{this.touch.pressed=!1,this.touch.delta[0]=0,this.touch.delta[1]=0},this.onTouchMove=e=>{const t=e.touches.item(0);t&&this.touch.pressed&&(this.touch.delta[0],this.touch.delta[0]=t.clientX-this.touch.position[0],this.touch.delta[1]=t.clientY-this.touch.position[1],this.touch.position[0]=t.clientX,this.touch.position[1]=t.clientY)},this.onMouseMove=e=>{this.pointerLocked&&(this.mouse.delta[0]=.5*e.movementX,this.mouse.delta[1]=.5*e.movementY,this.mouse.position[0]=e.pageX,this.mouse.position[1]=e.pageY)},this.keyDown=e=>(this.keyboard.keys[e.which]=1,!this.pointerLocked||(e.preventDefault(),!1)),this.keyUp=e=>(this.keyboard.keys[e.which]=0,!this.pointerLocked||(e.preventDefault(),!1)),this.onVisibilityChange=()=>{if(document.hidden){if(this.isPaused)return;this.pauseTime=P()/1e3,this.isPaused=!0}else{if(!this.isPaused)return;this.lastTime=P()/1e3-this.pauseTime+this.lastTime,this.isPaused=!1}},this.sounds=[],this.soundSystem=new F,this.config=e.config,this.loader=new Ne(this.config),this.loader.addEventListener("loadAll",(e=>{this.onLoadAll(e.detail.loader)})),document.addEventListener("touchstart",this.onTouchStart,!1),document.addEventListener("touchend",this.onTouchEnd,!1),document.addEventListener("touchcancel",this.onTouchEnd,!1),document.addEventListener("touchmove",this.onTouchMove,!1),document.addEventListener("mousemove",this.onMouseMove,!1),window.addEventListener("keydown",this.keyDown),window.addEventListener("keyup",this.keyUp),window.addEventListener("visibilitychange",this.onVisibilityChange),this.canvas=e.canvas,this.camera=st.init(this.canvas.width/this.canvas.height),this.context=e.context,this.renderer=e.renderer,this.worldScene=e.worldScene,this.skyScene=e.skyScene,this.mode=0,this.player=new at(this),this.mapName=""}static init(e){if(!rt.checkWebGLSupport().hasSupport)return{status:"error",message:"No WebGL support!"};const t=document.createElement("canvas");if(!t)return{status:"error",message:"Failed to create <canvas> element!"};const s=rt.init(t);if(!s)return{status:"error",message:"Failed to initialize WebGL context"};const i=ot.init(s);if(!i)return{status:"error",message:"Failed to initialize renderer"};const r=Wt.init(s);if(!r)return{status:"error",message:"Failed to initialize world scene"};const n=ht.init(s);if(!n)return{status:"error",message:"Failed to initialize sky scene"};return{status:"success",game:new Yt({canvas:t,config:e,context:s,renderer:i,worldScene:r,skyScene:n})}}getCanvas(){return this.canvas}load(e){this.dispatchEvent(R("loadstart")),this.loader.load(e)}changeMap(e){if(this.mapName.toLowerCase()===e.name.toLowerCase())return;this.mapName=e.name,this.worldScene.changeMap(e),this.skyScene.changeMap(e),this.entities=e.entities;const t=e.entities.find((e=>"info_player_start"===e.classname));t?(this.camera.position[0]=t.origin[0],this.camera.position[1]=t.origin[1],this.camera.position[2]=t.origin[2]):(this.camera.position[0]=0,this.camera.position[1]=0,this.camera.position[2]=0),this.camera.rotation[0]=0,this.camera.rotation[1]=0,this.camera.rotation[2]=0}changeReplay(e){this.player.changeReplay(e)}changeMode(e){this.mode=e,this.dispatchEvent(R("modechange"))}setTitle(e){this.title=e,this.dispatchEvent(R("titlechange",{detail:{item:e}}))}getTitle(){return this.title}update(e){this.dispatchEvent(R("preupdate",{detail:{item:this}}));const t=this.camera,s=this.keyboard,i=this.mouse,r=this.touch;if(1===this.mode)this.player.update(e);else if(0===this.mode){this.touch.pressed?(t.rotation[0]=Math.min(Math.max(t.rotation[0]+r.delta[1]/100,-Math.PI/2),Math.PI/2),t.rotation[1]-=r.delta[0]/100):(t.rotation[0]=Math.min(Math.max(t.rotation[0]+i.delta[1]/100,-Math.PI/2),Math.PI/2),t.rotation[1]-=i.delta[0]/100);const n=500*e,a=it.KEYS.W,o=it.KEYS.S,l=it.KEYS.A,h=it.KEYS.D,c=it.KEYS.C,d=it.KEYS.SPACE;s.keys[a]!==s.keys[o]&&(s.keys[a]?(t.position[1]-=Math.cos(t.rotation[1]+Math.PI/2)*n,t.position[0]+=Math.sin(t.rotation[1]+Math.PI/2)*n):s.keys[o]&&(t.position[1]-=Math.cos(t.rotation[1]-Math.PI/2)*n,t.position[0]+=Math.sin(t.rotation[1]-Math.PI/2)*n)),s.keys[l]!==s.keys[h]&&(s.keys[l]?(t.position[1]+=Math.cos(t.rotation[1])*n,t.position[0]-=Math.sin(t.rotation[1])*n):s.keys[h]&&(t.position[1]-=Math.cos(t.rotation[1])*n,t.position[0]+=Math.sin(t.rotation[1])*n)),s.keys[d]!==s.keys[c]&&(s.keys[d]?t.position[2]+=n:s.keys[c]&&(t.position[2]-=n))}i.delta[0]=0,i.delta[1]=0,this.dispatchEvent(R("postupdate",{detail:{item:this}}))}on(e,t){return this.addEventListener(e,t)}off(e,t){return this.removeEventListener(e,t)}}class jt{static init(e){return new jt({paths:{replays:e&&e.paths&&e.paths.replays,maps:e&&e.paths&&e.paths.maps,wads:e&&e.paths&&e.paths.wads,skies:e&&e.paths&&e.paths.skies,sounds:e&&e.paths&&e.paths.sounds,sprites:e&&e.paths&&e.paths.sprites}})}constructor(e){this.paths={...e.paths}}}let Kt=0;const qt=Object.create(null),Zt=["animation-iteration-count","border-image-outset","border-image-slice","border-image-width","box-flex","box-flex-group","box-ordinal-group","column-count","columns","counter-increment","counter-reset","flex","flex-grow","flex-positive","flex-shrink","flex-negative","flex-order","font-weight","grid-area","grid-column","grid-column-end","grid-column-span","grid-column-start","grid-row","grid-row-end","grid-row-span","grid-row-start","line-clamp","line-height","opacity","order","orphans","tab-size","widows","z-index","zoom","fill-opacity","flood-opacity","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-miterlimit","stroke-opacity","stroke-width"];for(const e of Zt)for(const t of["-webkit-","-ms-","-moz-","-o-",""])qt[t+e]=!0;function Qt(e,t){return t&&"number"==typeof t&&!qt[e]?`${e}:${t}px`:`${e}:${t}`}function Jt(e){return e.sort(((e,t)=>e[0]>t[0]?1:-1))}function es(e){return e.map((([e,t])=>Array.isArray(t)?t.map((t=>Qt(e,t))).join(";"):Qt(e,t))).join(";")}function ts(e,t){return-1===e.indexOf("&")?`${t} ${e}`:e.replace(/&/g,t)}function ss(e,t,s,i,r){const{style:n,nested:a,isUnique:o}=function(e,t){const s=[],i=[];for(const t of Object.keys(e)){const n=t.trim(),a=e[t];36!==n.charCodeAt(0)&&null!=a&&("object"!=typeof a||Array.isArray(a)?s.push([(r=n,r.replace(/[A-Z]/g,(e=>`-${e.toLowerCase()}`)).replace(/^ms-/,"-ms-")),a]):i.push([n,a]))}var r;return{style:es(Jt(s)),nested:t?i:Jt(i),isUnique:!!e.$unique}}(t,""!==e);let l=n;if(64===e.charCodeAt(0)){const t={selector:e,styles:[],rules:[],style:r?"":n};s.push(t),n&&r&&t.styles.push({selector:r,style:n,isUnique:o});for(const[e,s]of a)l+=e+ss(e,s,t.rules,t.styles,r)}else{const t=r?ts(e,r):e;n&&i.push({selector:t,style:n,isUnique:o});for(const[e,r]of a)l+=e+ss(e,r,s,i,t)}return l}function is(e,t,s,i,r,n){for(const{selector:s,style:a,isUnique:o}of i){const i=n?ts(s,r):s,l=o?`u\0${(++Kt).toString(36)}`:`s\0${t}\0${a}`,h=new ls(a,l);h.add(new os(i,`k\0${t}\0${i}`)),e.add(h)}for(const{selector:i,style:a,rules:o,styles:l}of s){const s=new hs(i,a,`r\0${t}\0${i}\0${a}`);is(s,t,o,l,r,n),e.add(s)}}function rs(e){let t="";for(let s=0;s<e.length;s++)t+=e[s];return t}const ns={add:()=>{},change:()=>{},remove:()=>{}};class as{constructor(e=ns){this.changes=e,this.sheet=[],this.changeId=0,this._keys=[],this._children=Object.create(null),this._counters=Object.create(null)}add(e){const t=this._counters[e.id]||0,s=this._children[e.id]||e.clone();if(this._counters[e.id]=t+1,0===t)this._children[s.id]=s,this._keys.push(s.id),this.sheet.push(s.getStyles()),this.changeId++,this.changes.add(s,this._keys.length-1);else if(s instanceof as&&e instanceof as){const t=this._keys.indexOf(e.id),i=s.changeId;s.merge(e),s.changeId!==i&&(this.sheet.splice(t,1,s.getStyles()),this.changeId++,this.changes.change(s,t,t))}}remove(e){const t=this._counters[e.id];if(t){this._counters[e.id]=t-1;const s=this._children[e.id],i=this._keys.indexOf(s.id);if(1===t)delete this._counters[e.id],delete this._children[e.id],this._keys.splice(i,1),this.sheet.splice(i,1),this.changeId++,this.changes.remove(s,i);else if(s instanceof as&&e instanceof as){const t=s.changeId;s.unmerge(e),s.changeId!==t&&(this.sheet.splice(i,1,s.getStyles()),this.changeId++,this.changes.change(s,i,i))}}}values(){return this._keys.map((e=>this._children[e]))}merge(e){for(const t of e.values())this.add(t);return this}unmerge(e){for(const t of e.values())this.remove(t);return this}clone(){return(new as).merge(this)}}class os{constructor(e,t){this.selector=e,this.id=t}getStyles(){return this.selector}clone(){return this}}class ls extends as{constructor(e,t){super(),this.style=e,this.id=t}getStyles(){return`${this.sheet.join(",")}{${this.style}}`}clone(){return new ls(this.style,this.id).merge(this)}}class hs extends as{constructor(e,t,s){super(),this.rule=e,this.style=t,this.id=s}getStyles(){return`${this.rule}{${this.style}${rs(this.sheet)}}`}clone(){return new hs(this.rule,this.style,this.id).merge(this)}}function cs(e,t){return`f${function(e){let t=5381,s=e.length;for(;s--;)t=33*t^e.charCodeAt(s);return(t>>>0).toString(36)}(e)}`}class ds extends as{constructor(e,t){super(t),this.id=e}registerStyle(e){const t=[],s=[],i=ss("&",e,t,s),r=cs(i);return is(this,i,t,s,`.${r}`,!0),r}registerKeyframes(e){return this.registerHashRule("@keyframes",e)}registerHashRule(e,t){const s=[],i=[],r=ss("",t,s,i),n=cs(r),a=new hs(`${e} ${n}`,"",`h\0${r}\0${e}`);return is(a,r,s,i,"",!1),this.add(a),n}registerRule(e,t){const s=[],i=[];is(this,ss(e,t,s,i),s,i,"",!1)}registerCss(e){return this.registerRule("",e)}getStyles(){return rs(this.sheet)}clone(){return new ds(this.id,this.changes).merge(this)}}function us(e){var t={};for(var s in e){var i=e[s];if("$nest"===s){var r=i;for(var n in r){var a=r[n];t[n]=us(a)}}else"$debugName"===s?t.$displayName=i:t[s]=i}return t}var ps="undefined"==typeof requestAnimationFrame?function(e){return setTimeout(e)}:"undefined"==typeof window?requestAnimationFrame:requestAnimationFrame.bind(window);function fs(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e.map((function(e){return e&&"object"==typeof e?Object.keys(e).map((function(t){return!!e[t]&&t})):[e]})).reduce((function(e,t){return e.concat(t)}),[]).filter((function(e){return!!e})).join(" ")}function ms(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var s={},i=0,r=e;i<r.length;i++){var n=r[i];if(null!=n&&!1!==n)for(var a in n){var o=n[a];(o||0===o)&&("$nest"===a&&o?s[a]=s.$nest?ms(s.$nest,o):o:-1!==a.indexOf("&")||0===a.indexOf("@media")?s[a]=s[a]?ms(s[a],o):o:s[a]=o)}}return s}var gs=function(){return new ds(`f${(++Kt).toString(36)}`,e);var e},Es=new(function(){function e(e){var t=this,s=e.autoGenerateTag;this.cssRaw=function(e){e&&(t._raw+=e||"",t._pendingRawChange=!0,t._styleUpdated())},this.cssRule=function(e){for(var s=[],i=1;i<arguments.length;i++)s[i-1]=arguments[i];var r=us(ms.apply(void 0,s));t._freeStyle.registerRule(e,r),t._styleUpdated()},this.forceRenderStyles=function(){var e=t._getTag();e&&(e.textContent=t.getStyles())},this.fontFace=function(){for(var e=[],s=0;s<arguments.length;s++)e[s]=arguments[s];for(var i=t._freeStyle,r=0,n=e;r<n.length;r++){var a=n[r];i.registerRule("@font-face",a)}t._styleUpdated()},this.getStyles=function(){return(t._raw||"")+t._freeStyle.getStyles()},this.keyframes=function(e){var s=function(e){var t={};for(var s in e)"$debugName"!==s&&(t[s]=e[s]);return e.$debugName&&(t.$displayName=e.$debugName),t}(e),i=t._freeStyle.registerKeyframes(s);return t._styleUpdated(),i},this.reinit=function(){var e=gs();t._freeStyle=e,t._lastFreeStyleChangeId=e.changeId,t._raw="",t._pendingRawChange=!1;var s=t._getTag();s&&(s.textContent="")},this.setStylesTarget=function(e){t._tag&&(t._tag.textContent=""),t._tag=e,t.forceRenderStyles()},this.stylesheet=function(e){for(var s={},i=0,r=Object.getOwnPropertyNames(e);i<r.length;i++){var n=r[i],a=e[n];a&&(a.$debugName=n,s[n]=t.style(a))}return s};var i=gs();this._autoGenerateTag=s,this._freeStyle=i,this._lastFreeStyleChangeId=i.changeId,this._pending=0,this._pendingRawChange=!1,this._raw="",this._tag=void 0,this.style=this.style.bind(this)}return e.prototype._afterAllSync=function(e){var t=this;this._pending++;var s=this._pending;ps((function(){s===t._pending&&e()}))},e.prototype._getTag=function(){if(this._tag)return this._tag;if(this._autoGenerateTag){var e="undefined"==typeof window?{textContent:""}:document.createElement("style");return"undefined"!=typeof document&&document.head.appendChild(e),this._tag=e,e}},e.prototype._styleUpdated=function(){var e=this,t=this._freeStyle.changeId,s=this._lastFreeStyleChangeId;(this._pendingRawChange||t!==s)&&(this._lastFreeStyleChangeId=t,this._pendingRawChange=!1,this._afterAllSync((function(){return e.forceRenderStyles()})))},e.prototype.style=function(){var e=this._freeStyle.registerStyle(us(ms.apply(void 0,arguments)));return this._styleUpdated(),e},e}())({autoGenerateTag:!0}),xs=Es.keyframes,ys=Es.stylesheet;const bs=ys({loading:{position:"relative",width:"100%",height:"100%",opacity:1,transition:"opacity 2s ease, z-index 1s linear",zIndex:30},loadingHidden:{position:"relative",width:"100%",height:"100%",opacity:1,transition:"opacity 2s ease, z-index 1s linear",zIndex:30,opacity:0,userSelect:"none",zIndex:0},spinner:{position:"absolute",left:"50%",top:"50%",marginLeft:"-40px",marginTop:"-40px",animation:"rotate 1s linear 0s infinite",height:"80px",width:"80px",animationName:xs({from:{transform:"rotate(0deg)"},to:{transform:"rotate(360deg)"}})},log:{position:"absolute",background:"rgba(0,0,0,0.4)",padding:"10px",fontFamily:"monospace",margin:"0",top:"16px",right:0,paddingLeft:"16px",listStyle:"none"},logItem:{display:"block"}}),_s={replay:"Replay",bsp:"Map",sound:"Sounds",sky:"Skybox",sprite:"Sprites",wad:"Wads"};class ws extends u{constructor(){super(...arguments),this.state={items:{}},this.onItemLoad=e=>{const t=this.state.items[e.type]?this.state.items[e.type]:[];for(let s=0;s<t.length;++s)if(t[s]===e)return;t.push({name:e.name,progress:0}),this.setState({items:{...this.state.items,[e.type]:t}})},this.onItemProgress=e=>{if(!this.state.items[e.type])return;const t=this.state.items[e.type];for(let s=0;s<t.length;++s)if(t[s].name===e.name){t[s].progress=e.progress;break}this.forceUpdate()}}componentDidMount(){const e=this.props.game.loader;e.addEventListener("loadstart",(e=>{this.onItemLoad(e.detail.item)})),e.addEventListener("progress",(e=>{this.onItemProgress(e.detail.item)}))}componentWillUnmount(){const e=this.props.game.loader;e.removeEventListener("loadstart",this.onItemLoad),e.removeEventListener("progress",this.onItemProgress)}formatItem(e,t){e=_s[e];const s=Math.round(100*t)+"%";let i=29-e.length-s.length;i<2&&(i=9-s.length);return`${e}${Array(i).join(".")}${s}`}render(){return h("div",{class:this.props.visible?bs.loading:bs.loadingHidden},h("div",{class:bs.spinner},h("svg",{xmlns:"http://www.w3.org/2000/svg",x:"0px",y:"0px",width:"80px",height:"80px",viewBox:"0 0 80 80",xmlSpace:"preserve"},h("path",{fill:"#ffffff",width:"10px",d:"M40,72C22.4,72,8,57.6,8,40C8,22.4,22.4,8,40,8c17.6,0,32,14.4,32,32c0,1.1-0.9,2-2,2s-2-0.9-2-2c0-15.4-12.6-28-28-28S12,24.6,12,40s12.6,28,28,28c1.1,0,2,0.9,2,2S41.1,72,40,72z"}))),h("ul",{class:bs.log},Object.entries(this.state.items).map((([e,t])=>h("li",{key:e,class:bs.logItem},this.formatItem(e,t.reduce(((e,t)=>e+t.progress),0)/t.length))))))}}const Ts=ys({controls:{height:"44px"}}),ks=ys({controls:{zIndex:30,position:"absolute",width:"100%",bottom:0,padding:"0 16px",boxSizing:"border-box",backgroundColor:"rgba(0, 0, 0, 0.4)",userSelect:"none",opacity:0,transition:"opacity 0.2s"},controlsVisible:{zIndex:30,position:"absolute",width:"100%",bottom:0,padding:"0 16px",boxSizing:"border-box",backgroundColor:"rgba(0, 0, 0, 0.4)",userSelect:"none",opacity:0,transition:"opacity 0.2s",opacity:1},buttons:{height:"100%",display:"flex",justifyContent:"space-between",marginBottom:"6px",alignItems:"center"},button:{width:"32px",height:"32px",padding:"7px",boxSizing:"border-box",cursor:"pointer"},left:{display:"flex",alignItems:"center",$nest:{"& .button":{marginRight:"8px"}}},right:{display:"flex",alignItems:"center",width:"70px",height:"100%",justifyContent:"space-between"}}),vs=ys({settings:{position:"relative"},menu:{display:"none",position:"absolute",left:"-38px",bottom:"48px",padding:"2px 6px",fontSize:"14px",backgroundColor:"rgba(0, 0, 0, 0.4)",flexFlow:"column",minWidth:"100px"},menuOpen:{display:"none",position:"absolute",left:"-38px",bottom:"48px",padding:"2px 6px",fontSize:"14px",backgroundColor:"rgba(0, 0, 0, 0.4)",flexFlow:"column",minWidth:"100px",display:"flex"},menuItemTitle:{padding:"6px 4px",borderBottom:"1px solid white",fontWeight:"bold"},menuItem:{cursor:"pointer",margin:"4px 0",padding:"4px",$nest:{"&:last-child":{marginTop:0},"&:hover":{backgroundColor:"rgba(255, 255, 255, 0.1)"}}},menuItemSelected:{cursor:"pointer",margin:"4px 0",padding:"4px",$nest:{"&:last-child":{marginTop:0},"&:hover":{backgroundColor:"rgba(255, 255, 255, 0.1)"}},backgroundColor:"rgba(255, 255, 255, 0.2) !important"},button:{width:"32px",height:"32px",padding:"5px"}});class Ss extends u{constructor(){super(...arguments),this.onFreeModeClick=()=>{this.props.game.mode!==zt.FREE&&(this.props.game.changeMode(zt.FREE),this.props.game.player.pause())},this.onReplayModeClick=()=>{this.props.game.mode!==zt.REPLAY&&this.props.game.changeMode(zt.REPLAY)},this.toggleMenu=()=>{this.setState({isOpen:!this.state.isOpen})}}render(){const e=!!this.props.game.player.replay;return h("div",{class:vs.settings},h("div",{class:fs(ks.button,vs.button),onClick:this.toggleMenu},h("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},h("path",{"fill-rule":"evenodd","clip-rule":"evenodd",fill:"#ffffff",d:"M23.9 10.7c0-0.3-0.4-0.6-0.8-0.6 -1.1 0-2.1-0.6-2.5-1.6 -0.4-1-0.1-2.2 0.7-3 0.3-0.2 0.3-0.6 0.1-0.9 -0.6-0.7-1.2-1.4-1.9-1.9 -0.3-0.2-0.7-0.2-0.9 0.1 -0.7 0.8-2 1.1-3 0.7 -1-0.4-1.7-1.5-1.6-2.6 0-0.4-0.2-0.7-0.6-0.7 -0.9-0.1-1.8-0.1-2.7 0C10.4 0.1 10.1 0.4 10.1 0.8 10.1 1.9 9.5 2.9 8.5 3.3 7.5 3.7 6.2 3.4 5.5 2.6c-0.2-0.3-0.6-0.3-0.9-0.1 -0.7 0.6-1.4 1.2-1.9 1.9C2.4 4.8 2.5 5.2 2.7 5.4c0.8 0.8 1.1 2 0.7 3 -0.4 1-1.4 1.6-2.6 1.6 -0.4 0-0.7 0.2-0.7 0.6 -0.1 0.9-0.1 1.8 0 2.7 0 0.3 0.4 0.6 0.8 0.6 1 0 2 0.6 2.5 1.6 0.4 1 0.2 2.2-0.7 3 -0.3 0.2-0.3 0.6-0.1 0.9 0.6 0.7 1.2 1.4 1.9 1.9 0.3 0.2 0.7 0.2 0.9-0.1 0.7-0.8 2-1.1 3-0.7 1 0.4 1.7 1.5 1.6 2.6 0 0.4 0.2 0.7 0.6 0.7C11.1 24 11.5 24 12 24c0.4 0 0.9 0 1.3-0.1 0.3 0 0.6-0.3 0.6-0.7 0-1.1 0.6-2.1 1.6-2.6 1-0.4 2.3-0.1 3 0.7 0.2 0.3 0.6 0.3 0.9 0.1 0.7-0.6 1.4-1.2 1.9-1.9 0.2-0.3 0.2-0.7-0.1-0.9 -0.8-0.8-1.1-2-0.7-3 0.4-1 1.4-1.6 2.5-1.6l0.1 0c0.3 0 0.7-0.2 0.7-0.6C24 12.5 24 11.6 23.9 10.7zM12 18c-3.3 0-6-2.7-6-6s2.7-6 6-6c3.3 0 6 2.7 6 6S15.3 18 12 18zM12 16"}))),h("div",{class:this.state.isOpen?vs.menuOpen:vs.menu},h("span",{class:vs.menuItemTitle},"Mode"),e?h("span",{class:this.props.game.mode===zt.REPLAY?vs.menuItemSelected:vs.menuItem,onClick:this.onReplayModeClick},"Replay"):h("span",null),h("span",{class:this.props.game.mode===zt.FREE?vs.menuItemSelected:vs.menuItem,onClick:this.onFreeModeClick},"Free")))}}const As=[{enabled:"fullscreenEnabled",element:"fullscreenElement",request:"requestFullscreen",exit:"exitFullscreen",change:"fullscreenchange",error:"fullscreenerror"},{enabled:"mozFullScreenEnabled",element:"mozFullScreenElement",request:"mozRequestFullScreen",exit:"mozCancelFullScreen",change:"mozfullscreenchange",error:"mozfullscreenerror"},{enabled:"webkitFullscreenEnabled",element:"webkitCurrentFullScreenElement",request:"webkitRequestFullscreen",exit:"webkitExitFullscreen",change:"webkitfullscreenchange",error:"webkitfullscreenerror"},{enabled:"msFullscreenEnabled",element:"msFullscreenElement",request:"msRequestFullscreen",exit:"msExitFullscreen",change:"MSFullscreenChange",error:"MSFullscreenError"}];let Is=0;const Ms=document;for(let e=0;e<As.length;++e)if(void 0!==Ms[As[e].enabled]){Is=e;break}class Rs{static element(){return Ms[As[Is].element]}static enabled(){return Ms[As[Is].enabled]}static isInFullscreen(){return null!==Rs.element()}static enter(e){e[As[Is].request]()}static exit(){Ms[As[Is].exit]()}static onChange(e){return window.addEventListener(As[Is].change,e)}static onChangeRemove(e){window.removeEventListener(As[Is].change,e)}static onError(e){return window.addEventListener(As[Is].error,e)}}const Ls=ys({button:{width:"30px",minWidth:"30px",height:"30px",padding:"5px"}});class Cs extends u{constructor(){super(...arguments),this.state={isInFullscreen:!1},this.onClick=()=>{Rs.isInFullscreen()?Rs.exit():Rs.enter(this.props.root)},this.onFullscreen=()=>{this.setState({isInFullscreen:Rs.isInFullscreen()})}}componentDidMount(){Rs.onChange(this.onFullscreen)}componentWillUnmount(){Rs.onChangeRemove(this.onFullscreen)}render(){return h("div",{class:fs(ks.button,Ls.button),onClick:this.onClick},this.state.isInFullscreen?h("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64",fill:"currentcolor"},h("path",{d:"M0 22 L22 22 L22 0 L14 0 L14 14 L0 14 M42 0 L42 22 L64 22 L64 14 L50 14 L50 0 M14 50 L0 50 L0 42 L22 42 L22 64 L14 64 M42 64 L42 42 L64 42 L64 50 L50 50 L50 64 Z"})):h("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64",fill:"currentcolor"},h("path",{d:"M0 22 L8 22 L8 8 L22 8 L22 0 L0 0 M42 0 L42 8 L56 8 L56 22 L64 22 L64 0 M0 64 L0 42 L8 42 L8 56 L22 56 L22 64 M64 64 L42 64 L42 56 L56 56 L56 42 L64 42 Z"})))}}function Ps(e){return h("div",{class:fs(e.class,Ts.controls)},h("div",{class:ks.buttons},h("div",{class:ks.left}),h("div",{class:ks.right},h(Ss,{game:e.game}),h(Cs,{active:!1,root:e.root}))))}const Ns=ys({time:{fontFamily:"'Roboto', Arial, Helvetica, sans-serif",fontSize:"10pt"}});class Ds extends u{constructor(){super(...arguments),this.onPlay=()=>{this.setState({isPlaying:!0},this.update)},this.onPauseOrStop=()=>{this.setState({isPlaying:!1})},this.update=()=>{this.state.isPlaying&&(this.forceUpdate(),setTimeout(this.update,100))}}componentDidMount(){this.props.player.on("play",this.onPlay),this.props.player.on("pause",this.onPauseOrStop),this.props.player.on("stop",this.onPauseOrStop)}componentWillUnmount(){this.props.player.off("play",this.onPlay),this.props.player.off("pause",this.onPauseOrStop),this.props.player.off("stop",this.onPauseOrStop)}render(){const e=N(this.props.player.currentTime),t=N(this.props.player.replay.length);return h("div",{class:Ns.time},e," / ",t)}}const Us=ys({timeline:{display:"flex",alignItems:"center",position:"relative",height:"26px",cursor:"pointer"},line:{height:"4px",backgroundColor:"#fff",position:"absolute",left:"0",right:"0",borderRadius:"2px"},ghostLine:{height:"4px",backgroundColor:"rgba(255, 255, 255, 0.5)",position:"absolute",left:"0",right:"0",borderRadius:"2px"},knob:{position:"absolute",width:"12px",height:"12px",backgroundColor:"#fff",borderRadius:"6px",left:"100%",marginLeft:"-6px"},ghostKnob:{position:"absolute",width:"8px",height:"8px",backgroundColor:"#fff",boxSizing:"border-box",borderRadius:"8px",left:"0",marginLeft:"-4px",display:"none",$nest:{"&:hover":{display:"block"}}}});class Fs extends u{constructor(e){super(e),this.onPostUpdate=()=>{const e=this.props.game.player;this.setState({progress:e.currentTime/e.replay.length})},this.onClick=e=>{const t=e.currentTarget.getClientRects()[0],s=1-(t.right-e.pageX)/(t.right-t.left);this.props.game.player.seekByPercent(100*s),this.props.game.player.pause()},this.onMouseEnter=()=>{this.setState({ghostKnobActive:!0})},this.onMouseMove=e=>{if(!this.state.ghostKnobActive)return;const t=e.currentTarget.getClientRects()[0],s=100*(1-(t.right-e.pageX)/(t.right-t.left))+"%";this.setState({ghostKnobPos:s})},this.onMouseLeave=()=>{this.setState({ghostKnobActive:!1})},this.state={progress:0,ghostKnobActive:!1,ghostKnobPos:"0%"}}componentDidMount(){this.props.game.on("postupdate",this.onPostUpdate)}componentWillUnmount(){this.props.game.off("postupdate",this.onPostUpdate)}render(){const e=100*this.state.progress,t=e+"%",s=100-e+"%";return h("div",{class:Us.timeline,onClick:this.onClick,onMouseEnter:this.onMouseEnter,onMouseMove:this.onMouseMove,onMouseLeave:this.onMouseLeave},h("div",{class:Us.ghostLine}),h("div",{class:Us.line,style:{right:s}}),h("div",{class:Us.knob,style:{left:t}}),h("div",{class:Us.ghostKnob,style:{left:this.state.ghostKnobPos}}))}}const Os=ys({control:{display:"flex",alignItems:"center",position:"relative",width:"80px",height:"26px",marginLeft:"6px",marginRight:"14px",cursor:"pointer"},line:{height:"4px",backgroundColor:"#fff",position:"absolute",left:"0",right:"0",borderRadius:"2px"},ghostLine:{height:"4px",backgroundColor:"rgba(255, 255, 255, 0.5)",position:"absolute",left:"0",right:"0",borderRadius:"2px"},knob:{position:"absolute",width:"12px",height:"12px",backgroundColor:"#fff",borderRadius:"6px",left:"100%",marginLeft:"-6px"},ghostKnob:{position:"absolute",width:"8px",height:"8px",backgroundColor:"#fff",boxSizing:"border-box",borderRadius:"8px",left:"0",marginLeft:"-4px",display:"none",$nest:{"&:hover":{display:"block"}}}});class Bs extends u{constructor(e){super(e),this.onVolumeChange=()=>{this.setState({volume:this.props.game.soundSystem.getVolume()})},this.onClick=e=>{const t=e.currentTarget.getClientRects()[0],s=1-(t.right-e.pageX)/(t.right-t.left);this.props.game.soundSystem.setVolume(s)},this.onMouseEnter=()=>{this.setState({ghostKnobActive:!0})},this.onMouseMove=e=>{if(!this.state.ghostKnobActive)return;const t=e.currentTarget.getClientRects()[0],s=1-(t.right-e.pageX)/(t.right-t.left),i=Math.min(95,Math.max(5,100*s))+"%";this.setState({ghostKnobPos:i})},this.onMouseLeave=()=>{this.setState({ghostKnobActive:!1})},this.state={volume:e.game.soundSystem.getVolume(),ghostKnobActive:!1,ghostKnobPos:"5%"}}componentDidMount(){this.props.game.soundSystem.addEventListener("volumeChange",(()=>{this.onVolumeChange()}))}componentWillUnmount(){this.props.game.soundSystem.removeEventListener("volumeChange",this.onVolumeChange)}render(){const e=100*this.state.volume,t=Math.min(95,Math.max(5,e))+"%",s=Math.min(95,Math.max(5,100-e))+"%";return h("div",{class:Os.control,onClick:this.onClick,onMouseEnter:this.onMouseEnter,onMouseMove:this.onMouseMove,onMouseLeave:this.onMouseLeave},h("div",{class:Os.ghostLine}),h("div",{class:Os.line,style:{right:s}}),h("div",{class:Os.knob,style:{left:t}}),h("div",{class:Os.ghostKnob,style:{left:this.state.ghostKnobPos}}))}}function Vs(e){return h("div",{class:ks.button,onClick:e.onClick},h("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64",fill:"currentcolor"},h("path",{d:"M0 0 L0 64 L64 32 Z"})))}function Gs(e){return h("div",{class:ks.button,onClick:e.onClick},h("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64",fill:"currentcolor"},h("path",{d:"M0 0 L0 64 L20 64 L20 0 M44 0 L64 0 L64 64 L44 64 Z"})))}const Xs=ys({button:{width:"28px",height:"28px",padding:"2px",marginRight:"5px"}});function Hs(e){return h("div",{class:fs(ks.button,Xs.button),onClick:e.onClick},h("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48",fill:"currentcolor"},h("path",{d:"M6 18v12h8l10 10V8L14 18H6zm27 6c0-3.53-2.04-6.58-5-8.05v16.11c2.96-1.48 5-4.53 5-8.06zM28 6.46v4.13c5.78 1.72 10 7.07 10 13.41s-4.22 11.69-10 13.41v4.13c8.01-1.82 14-8.97 14-17.54S36.01 8.28 28 6.46z"})))}function Ws(e){return h("div",{class:ks.button,onClick:e.onClick},h("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64",fill:"currentcolor"},h("path",{d:"M0 0 L0 64 L32 32 L32 64 L64 32 L32 0 L32 32 Z"})))}const zs=ys({button:{transform:"rotate(180deg)"}});function $s(e){return h("div",{class:fs(ks.button,zs.button),onClick:e.onClick},h("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64",fill:"currentcolor"},h("path",{d:"M0 0 L0 64 L32 32 L32 64 L64 32 L32 0 L32 32 Z"})))}class Ys extends u{constructor(){super(...arguments),this.onPlayClick=()=>{this.props.game.player.play()},this.onPauseClick=()=>{this.props.game.player.pause()},this.onSpeedDown=()=>{this.props.game.player.speedDown()},this.onSpeedUp=()=>{this.props.game.player.speedUp()},this.onVolumeClick=()=>{this.props.game.soundSystem.toggleMute()},this.onPlayStateChange=()=>{this.forceUpdate()}}componentDidMount(){this.props.game.player.on("play",this.onPlayStateChange),this.props.game.player.on("pause",this.onPlayStateChange),this.props.game.player.on("stop",this.onPlayStateChange)}componentWillUnmount(){this.props.game.player.off("play",this.onPlayStateChange),this.props.game.player.off("pause",this.onPlayStateChange),this.props.game.player.off("stop",this.onPlayStateChange)}render(){const e=this.props.game,t=e.player,s=t.isPlaying,i=t.isPaused;return h("div",{class:this.props.class},h(Fs,{game:e}),h("div",{class:ks.buttons},h("div",{class:ks.left},h($s,{onClick:this.onSpeedDown}),i||!s?h(Vs,{onClick:this.onPlayClick}):h(Gs,{onClick:this.onPauseClick}),h(Ws,{onClick:this.onSpeedUp}),h(Hs,{onClick:this.onVolumeClick}),h(Bs,{game:e}),h(Ds,{player:t})),h("div",{class:ks.right},h(Ss,{game:e}),h(Cs,{active:!0,root:this.props.root}))))}}const js=ys({root:{position:"relative",color:"white",width:"100%",height:"100%",cursor:"none",userSelect:"none"},rootVisible:{position:"relative",color:"white",width:"100%",height:"100%",cursor:"none",userSelect:"none",cursor:"default"},title:{position:"absolute",bottom:"6.5%",left:"1.6%",zIndex:20,opacity:0,transition:"opacity 0.2s"},titleVisible:{position:"absolute",bottom:"6.5%",left:"1.6%",zIndex:20,opacity:0,transition:"opacity 0.2s",opacity:1},controls:{zIndex:30,position:"absolute",width:"100%",bottom:0,padding:"0 16px",boxSizing:"border-box",backgroundColor:"rgba(0, 0, 0, 0.4)",userSelect:"none",opacity:0,transition:"opacity 0.2s"},controlsVisible:{zIndex:30,position:"absolute",width:"100%",bottom:0,padding:"0 16px",boxSizing:"border-box",backgroundColor:"rgba(0, 0, 0, 0.4)",userSelect:"none",opacity:0,transition:"opacity 0.2s",opacity:1},screen:{position:"absolute",top:0,left:0,width:"100%",height:"100%",zIndex:10}});class Ks extends u{constructor(e){super(e),this.node=null,this.fadeOut=0,this.onPointerLockChange=()=>{document.pointerLockElement===this.props.root?this.props.game.pointerLocked=!0:this.props.game.pointerLocked=!1},this.onContextMenu=e=>{e.preventDefault()},this.onWindowClick=()=>{this.setState({isActive:!1})},this.onRootClick=e=>{e.stopPropagation(),this.setState({isActive:!0}),this.fadeReset()},this.onKeyDown=e=>{if(!this.state.isActive)return;const t=this.props.game;switch(e.which){case 70:Rs.isInFullscreen()?Rs.exit():Rs.enter(this.props.root),this.fadeReset();break;case 77:t.soundSystem.toggleMute(),this.fadeReset();break;case 38:t.soundSystem.setVolume(t.soundSystem.getVolume()+.05),this.fadeReset();break;case 40:t.soundSystem.setVolume(t.soundSystem.getVolume()-.05),this.fadeReset();break;case 74:case 37:t.player.seek(t.player.currentTime-5),this.fadeReset();break;case 76:case 39:t.player.seek(t.player.currentTime+5),this.fadeReset();break;case 75:case 32:if(this.props.game.mode!==zt.REPLAY)return;!t.player.isPlaying||t.player.isPaused?t.player.play():t.player.pause()}},this.onModeChange=()=>{this.forceUpdate()},this.onLoadStart=()=>{this.setState({isLoading:!0})},this.onLoadEnd=()=>{this.props.game.player.play(),this.setState({isLoading:!1})},this.onTitleChange=e=>{this.setState({title:e})},this.onMouseEnter=()=>{this.setState({isMouseOver:!0}),this.fadeReset()},this.onMouseMove=()=>{this.state.isMouseOver&&!Rs.isInFullscreen()&&this.fadeReset()},this.onMouseLeave=()=>{this.setState({isMouseOver:!1,isVisible:!1}),clearTimeout(this.fadeOut),this.fadeOut=0},this.fadeReset=()=>{this.state.isVisible||this.setState({isVisible:!0}),clearTimeout(this.fadeOut),this.fadeOut=setTimeout((()=>{this.setState({isVisible:!1}),this.fadeOut=0}),5e3)},this.onScreenClick=()=>{switch(this.props.game.mode){case zt.REPLAY:{const e=this.props.game.player;!e.isPlaying||e.isPaused?e.play():e.pause();break}case zt.FREE:this.props.root.requestPointerLock()}},this.onScreenDblClick=()=>{Rs.isInFullscreen()?Rs.exit():Rs.enter(this.props.root)},this.state={title:e.game.title,isActive:!1,isLoading:!1,isMouseOver:!1,isVisible:!1}}componentDidMount(){if(!this.node)return;const e=this.props.game,t=this.props.root;this.node.appendChild(e.getCanvas()),e.on("loadstart",this.onLoadStart),e.on("load",this.onLoadEnd),e.on("modechange",this.onModeChange),e.on("titlechange",this.onTitleChange),t.addEventListener("click",this.onRootClick),window.addEventListener("click",this.onWindowClick),window.addEventListener("keydown",this.onKeyDown),document.addEventListener("pointerlockchange",this.onPointerLockChange,!1),t.addEventListener("mouseover",this.onMouseEnter),t.addEventListener("mousemove",this.onMouseMove),t.addEventListener("mouseout",this.onMouseLeave),t.addEventListener("contextmenu",this.onContextMenu)}componentWillUnmount(){const e=this.props.game,t=this.props.root;e.off("loadstart",this.onLoadStart),e.off("load",this.onLoadEnd),e.off("modechange",this.onModeChange),e.off("titlechange",this.onTitleChange),t.removeEventListener("click",this.onRootClick),window.removeEventListener("click",this.onWindowClick),window.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("pointerlockchange",this.onPointerLockChange,!1),t.removeEventListener("mouseover",this.onMouseEnter),t.removeEventListener("mousemove",this.onMouseMove),t.removeEventListener("mouseout",this.onMouseLeave),t.removeEventListener("contextmenu",this.onContextMenu)}render(){const e=this.props.game,t=this.state.isVisible;return h("div",{class:t?js.rootVisible:js.root},h("button",{id:"toggle-ui",class:t?js.titleVisible:js.title,onClick:()=>this.props.toggleUI()},"Toggle Menu"),h(ws,{game:e,visible:this.state.isLoading}),h("div",{class:js.screen,ref:e=>this.node=e,onClick:this.onScreenClick,onDblClick:this.onScreenDblClick}),e.mode===zt.FREE?h(Ps,{class:t?js.controlsVisible:js.controls,game:e,root:this.props.root}):h(Ys,{class:t?js.controlsVisible:js.controls,game:e,root:this.props.root,visible:this.state.isMouseOver}))}}class qs extends u{render(e){return h(d,null,h("div",{class:"window file-upload",name:this.props.headerName},h("div",{class:"box inset",id:"item-list"},e.fileNames.map((e=>h("p",{class:"menu-item",onClick:this.props.callBack},e.name))))))}}
// @license  2020 Google LLC. Licensed under the Apache License, Version 2.0.
const Zs="chooseFileSystemEntries"in self?"chooseFileSystemEntries":"showOpenFilePicker"in self&&"showOpenFilePicker";
// @license  2020 Google LLC. Licensed under the Apache License, Version 2.0.
Zs?"chooseFileSystemEntries"===Zs?import("./file-open.7157b3fd.js"):import("./file-open.6f88a7b6.js"):import("./file-open.02cf4477.js");
// @license  2020 Google LLC. Licensed under the Apache License, Version 2.0.
const Qs=Zs?"chooseFileSystemEntries"===Zs?import("./directory-open.bf881023.js"):import("./directory-open.986a8b8b.js"):import("./directory-open.e6a713b1.js");
// @license  2020 Google LLC. Licensed under the Apache License, Version 2.0.
Zs?"chooseFileSystemEntries"===Zs?import("./file-save.ae0de169.js"):import("./file-save.5909776a.js"):import("./file-save.ff8b2a30.js");class Js extends u{constructor(e){super(e),this.fileUpload={current:null},this.loadGameDir=async()=>{let e={};const t=await async function(...e){return(await Qs).default(...e)}({recursive:!0});["bsp","dem","wad","wav","tga","spr"].forEach((s=>{const i=new RegExp("."+s,"i");e[s]=t.filter((e=>e.name.match(i)))})),this.setState({localAssets:e,filesLoaded:!0})},this.loadMap=({currentTarget:e})=>{const t=e.innerText;this.props.init({mapName:t,assets:this.state.localAssets,type:"map"}),this.props.toggleUI(!1)},this.loadDemo=({currentTarget:e})=>{const t=e.innerText;this.props.init({demoName:t,assets:this.state.localAssets,type:"demo",showUI:!1}),this.props.toggleUI(!1)},this.state={errored:!1,filesLoaded:!1,localAssets:null,maps:null,demos:null}}render(){return h("div",{id:"interface-container"},this.props.showUI?h(d,null,this.state.localAssets?h("div",{id:"window-container"},h(d,null,h(qs,{fileNames:this.state.localAssets.bsp,headerName:"Maps",callBack:this.loadMap}),h(qs,{fileNames:this.state.localAssets.dem,headerName:"Demos",callBack:this.loadDemo}))):null):null,this.state.filesLoaded?null:h("div",{class:"window file-upload",name:"Web HL"},h("button",{onClick:this.loadGameDir},"Open Game Directory")))}}class ei extends u{constructor(){super(),this.init=e=>{this.game?"demo"===e.type?(this.startDemo(e.demoName),console.warn()):this.startMap(e.mapName):(this.initHLV("#hlv-target",{paths:{replays:e.assets.dem,maps:e.assets.bsp,wads:e.assets.wad,skies:e.assets.tga,sounds:e.assets.wav,sprites:e.assets.spr}}),"demo"===e.type?this.startDemo(e.demoName):this.startMap(e.mapName))},this.startDemo=e=>{this.game?this.game.load(e):console.error("HLViewer not Instantiated yet")},this.startMap=e=>{this.game?this.game.load(e):console.error("HLViewer not Instantiated yet")},this.toggleUI=e=>{this.setState({showUI:e||!this.state.showUI})},this.game=null,this.rootNode=null,this.state={showUI:!0}}initHLV(e,t){const s=document.querySelector(e);if(!s)return null;const i=jt.init(t),r=Yt.init(i);return"success"===r.status&&(this.game=r.game,this.rootNode=s,this.drawInterface(),this.game.draw()),null}componentWillUnmount(){this.game=null}drawInterface(){M(h(Ks,{game:this.game,root:this.rootNode,toggleUI:this.toggleUI}),this.rootNode)}render(){return h(d,null,h(Js,{init:this.init,showUI:this.state.showUI,toggleUI:this.toggleUI}),h("div",{id:"hlv-target"}))}}const ti=document.getElementById("app");ti&&M(h(ei,null),ti);
